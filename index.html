<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEC Kiosk</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Kiosk Mode: Fullscreen feel, allow vertical scroll on small screens */
        html, body, #app { height: 100%; margin: 0; padding: 0; }
        #app { overflow-y: auto; }
        /* FullCalendar styling tweaks - Ensure visibility in dark mode */
        .fc-toolbar-title { 
            font-size: 1.5rem !important; 
            font-weight: 800; 
            color: #ec4899; /* Always visible pink */
        }
        /* Enforce dark style for calendar buttons */
        .fc-button, .fc-button:hover { 
            background-color: #4b5563; /* dark gray buttons */
            border-color: #374151;
            color: #d1d5db; /* light text */
        }
        .fc-event-title { white-space: normal; }
        /* Adjust calendar padding for mobile */
        #calendar { padding: 0.5rem; }
        @media (min-width: 768px) {
            #calendar { padding: 1rem; }
        }
        #map { height: 100%; width: 100%; border-radius: 0.5rem; }
    </style>

    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <!-- FullCalendar CSS and JS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js'></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Leaflet JS for Map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
</head>
<body>

    <!-- Removed dark:bg-gray-900, using it as the default -->
    <div id="app" class="flex flex-col bg-gray-900 h-screen transition-colors duration-300">

        <!-- HEADER (Pink and Grey) - Sign-in button and dark mode toggle removed -->
        <header class="bg-gray-800 text-white shadow-xl p-4 flex justify-between items-center z-10 sticky top-0">
            <h1 class="text-xl md:text-3xl font-extrabold tracking-tight text-pink-400">
                <span id="school-name">BCSTEC</span> Kiosk
            </h1>
            <!-- User Status (Always shows viewer status) -->
            <span id="user-status" class="text-xs md:text-sm font-semibold rounded-full px-2 py-1 md:px-3 md:py-1 bg-pink-700">
                Kiosk View Mode
            </span>
        </header>

        <!-- MAIN CONTENT AREA: Stacks vertically on mobile -->
        <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
            <!-- SIDEBAR/FILTERS: Permanent dark theme applied -->
            <aside id="filter-sidebar" class="w-full md:w-1/4 md:max-w-xs bg-gray-800 p-4 md:overflow-y-auto border-r border-gray-700 shadow-md transition-colors duration-300">
                <h2 class="text-xl font-bold mb-4 text-pink-400">Filter Schedule</h2>

                <!-- Program Tabs (Junior/Senior) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Program:</label>
                    <div class="flex space-x-2" id="program-tabs">
                        <!-- Classes adjusted to permanent dark state -->
                        <button data-program="Junior High" class="program-tab bg-pink-900 text-pink-100 font-semibold py-2 px-4 rounded-lg flex-1 shadow-sm hover:bg-pink-800 transition duration-150 text-sm">Junior High</button>
                        <button data-program="Senior High" class="program-tab bg-gray-700 text-gray-300 font-semibold py-2 px-4 rounded-lg flex-1 shadow-sm hover:bg-gray-600 transition duration-150 text-sm">Senior High</button>
                    </div>
                </div>

                <!-- Grade Level Filter (Dynamic) -->
                <div class="mb-4">
                    <label for="grade-filter" class="block text-sm font-medium text-gray-300 mb-2">Grade Level:</label>
                    <select id="grade-filter" class="w-full p-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-pink-500 focus:border-pink-500 shadow-sm text-sm"></select>
                </div>

                <!-- Section Filter (Dynamic) -->
                <div class="mb-4">
                    <label for="section-filter" class="block text-sm font-medium text-gray-300 mb-2">Section:</label>
                    <select id="section-filter" class="w-full p-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-pink-500 focus:border-pink-500 shadow-sm text-sm"></select>
                </div>

                <!-- See Schedule Button -->
                <button id="see-schedule-button"
                        class="w-full bg-pink-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-pink-700 transition duration-300 mt-4 text-sm">
                    See Schedule
                </button>

                <!-- Ask Assistant Button (UPDATED NAME) -->
                <button id="ask-assistant-button"
                        class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 mt-4 text-sm">
                    Ask STEC-Buddy (AI)
                </button>

                <!-- Action Button for Admins/Teachers - Permanently Hidden -->
                <button id="add-schedule-button"
                        class="hidden w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-600 transition duration-300 mt-4 text-sm">
                    + Add New Class
                </button>

                <!-- Map View Toggle -->
                <div class="mt-6 pt-4 border-t border-gray-700">
                    <h3 class="text-lg font-bold text-pink-400 mb-2">Campus Map</h3>
                    <button id="map-toggle-button"
                            class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-gray-700 transition duration-300 text-sm">
                        View Floor Plan
                    </button>
                </div>

            </aside>

            <!-- MAIN VIEW (Calendar or Map) - FIX: Added flex flex-col and changed overflow-auto to overflow-hidden -->
            <main id="main-view-container" class="flex-grow flex flex-col bg-gray-800 overflow-hidden transition-colors duration-300">
                <!-- Calendar View - FIX: Changed h-full to flex-grow to ensure it takes remaining vertical space -->
                <div id="calendar-view" class="flex-grow w-full min-h-[500px] md:min-h-0">
                    <div id='calendar' class="h-full w-full"></div>
                </div>
                <!-- Map View (Hidden by default) -->
                <div id="map-view" class="h-full w-full hidden p-4">
                    <h2 class="text-xl md:text-2xl font-bold mb-4 text-pink-400">Floor Plan Hotspots</h2>
                    <div id="map" class="h-[80vh] md:h-[90%] w-full"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODAL: Class Detail (Edit form permanently hidden) - Permanent dark theme applied -->
    <div id="detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-lg transition-colors duration-300">
            <h3 id="detail-title" class="text-2xl font-bold mb-4 text-pink-400">Class Details</h3>
            <div id="detail-content" class="space-y-3 text-gray-300">
                <p><span class="font-medium">Subject:</span> <span id="detail-subject"></span></p>
                <p><span class="font-medium">Teacher:</span> <span id="detail-teacher"></span></p>
                <p><span class="font-medium">Room:</span> <span id="detail-room"></span></p>
                <p><span class="font-medium">Time:</span> <span id="detail-time"></span></p>
                <p><span class="font-medium">Program:</span> <span id="detail-program"></span></p>
            </div>
            <!-- Edit Form is permanently hidden for Kiosk mode -->
            <form id="edit-form" class="mt-6 space-y-4 hidden">
                <h4 class="text-xl font-semibold border-t pt-4 text-pink-400 border-gray-700">Edit Class (Admin/Teacher)</h4>
                <input type="hidden" id="edit-id">

                <label class="block text-sm font-medium text-gray-300">New Subject:</label>
                <input type="text" id="edit-subject" required class="w-full p-2 border rounded border-gray-600 bg-gray-700 text-white focus:ring-pink-500 focus:border-pink-500">

                <label class="block text-sm font-medium text-gray-300">New Start Time (YYYY-MM-DD HH:MM):</label>
                <input type="datetime-local" id="edit-start" required class="w-full p-2 border rounded border-gray-600 bg-gray-700 text-white focus:ring-pink-500 focus:border-pink-500">

                <label class="block text-sm font-medium text-gray-300">New Room:</label>
                <select id="edit-room" class="w-full p-2 border rounded border-gray-600 bg-gray-700 text-white focus:ring-pink-500 focus:border-pink-500"></select>

                <div class="flex flex-col space-y-2 md:space-y-0 md:flex-row md:space-x-4">
                    <button type="submit" class="flex-1 bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700 transition duration-300">Save Changes</button>
                    <button id="delete-class-button" type="button" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 transition duration-300">Delete Class</button>
                </div>
            </form>

            <button id="close-detail-modal" class="mt-6 w-full bg-gray-700 text-gray-300 py-2 rounded-lg hover:bg-gray-600 transition duration-300">Close</button>
        </div>
    </div>
    
    <!-- MODAL: Assistant Chat (NEW NAME: STEC-Buddy) -->
    <div id="assistant-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-lg transition-colors duration-300 flex flex-col h-5/6">
            <h3 class="text-2xl font-bold mb-4 text-blue-400 border-b border-gray-700 pb-2">STEC-Buddy: Your Kiosk Assistant</h3>
            
            <!-- Chat History Container -->
            <div id="chat-history" class="flex-grow overflow-y-auto space-y-4 mb-4 pr-2">
                <!-- Initial Welcome Message will be rendered here -->
            </div>
            
            <!-- Input and Send Button -->
            <form id="chat-form" class="flex space-x-3">
                <input type="text" id="chat-input" placeholder="Ask a question..." required
                       class="flex-grow p-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                <button type="submit" id="chat-send-button"
                        class="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex-shrink-0 disabled:bg-gray-500">
                    Send
                </button>
            </form>

            <button id="close-assistant-modal" class="mt-6 w-full bg-gray-700 text-gray-300 py-2 rounded-lg hover:bg-gray-600 transition duration-300">Close</button>
        </div>
    </div>


    <script type="module">
        // ====================================================================
        // SUPABASE CONFIGURATION
        // ====================================================================
        const SUPABASE_URL = 'https://nwwkgmlnnlsmbjrvcnaj.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53d2tnbWxubmxzbWJqcnZjbmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTYxMDcsImV4cCI6MjA4MTM3MjEwN30.Stz0PC0XAxlAkmHpWxY9reIeVzbXaDKuiSUOrJ4HB7Y'; 

        // Check for placeholder
        if (SUPABASE_URL.startsWith('YOUR')) {
            console.error("CRITICAL ERROR: Please update SUPABASE_URL and SUPABASE_ANON_KEY in the script.");
        }

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let calendar = null;
        let map = null;
        let allClasses = [];
        let allRooms = [];
        let allProfiles = [];
        let allPrograms = []; // Master list of programs for filters
        // Role is permanently set to student as Kiosk is public
        const currentRole = 'student'; 
        let currentProgram = 'Junior High';
        let currentGrade = null;
        let currentSection = null;
        
        // ====================================================================
        // GEMINI API KEY CONFIGURATION
        // 
        // NOTE: If running this code outside of the Canvas environment, 
        // REPLACE the empty string with your actual Gemini API Key.
        // ====================================================================
        const GEMINI_API_KEY = "AIzaSyALJamFpolfBxaOMWidlkZRK2dk4Gx3mH8"; 
        
        let chatHistory = [{
            role: "model",
            parts: [{ text: "Hello! I am **STEC-Buddy**, your helpful Kiosk Assistant. I can answer questions about the school, schedules, and rooms. How can I help you today?" }]
        }];


        // ====================================================================
        // DATA FETCHING AND REAL-TIME SUBSCRIPTIONS
        // Kiosk mode fetches data for viewing only.
        // ====================================================================

        /**
         * Fetches all static data (Rooms, Profiles, and Programs)
         */
        async function fetchStaticData() {
            try {
                const { data: rooms, error: roomError } = await supabase.from('rooms').select('*');
                if (roomError) throw roomError;
                allRooms = rooms;
                console.log('Fetched Rooms:', allRooms.length);
                initializeMap();

                const { data: profiles, error: profileError } = await supabase.from('profiles').select('id, full_name, role');
                if (profileError) throw profileError;
                allProfiles = profiles;
                console.log('Fetched Profiles:', allProfiles.length);
                
                // Fetch the master list of programs for filters
                const { data: programs, error: programError } = await supabase.from('programs').select('*');
                if (programError) throw programError;
                allPrograms = programs;
                console.log('Fetched Programs:', allPrograms.length);

                renderFilters(); // Render filters immediately after fetching master programs list

            } catch (error) {
                console.error('Error fetching static data:', error.message);
            }
        }

        /**
         * Sets up the Realtime listener for class schedules.
         */
        function setupRealtimeListener() {
            // Subscribe to changes in the classes table
            supabase
                .channel('classes_changes')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'classes' },
                    (payload) => {
                        console.log('Realtime change received:', payload);
                        fetchAndRenderClasses(); // Refetch all classes on any change
                    }
                )
                .subscribe();

            // Initial fetch
            fetchAndRenderClasses();
        }

        /**
         * Fetches all class schedules and updates the calendar.
         */
        async function fetchAndRenderClasses() {
            try {
                // Fetch classes and join necessary profile and room data
                const { data, error } = await supabase
                    .from('classes')
                    .select(`
                        id, subject, start_time, end_time, room_id,
                        programs(name, grade_level, section),
                        rooms(id, name, floor, map_coords),
                        teacher:profiles(full_name)
                    `);

                if (error) throw error;
                allClasses = data;
                console.log('Fetched Classes:', allClasses.length);
                
                // We call renderCalendar here only to ensure the calendar exists initially, 
                // but subsequent rendering will rely on the "See Schedule" button click.
                if (!calendar) {
                    renderCalendar();
                }

            } catch (error) {
                console.error('Error fetching classes:', error.message);
                if (error.code === 'PGRST116') {
                    allClasses = [];
                    if (!calendar) renderCalendar();
                }
            }
        }

        // ====================================================================
        // UI RENDERING FUNCTIONS
        // ====================================================================

        /**
         * Renders filter dropdowns based on current data (master list of programs).
         */
        function renderFilters() {
            // Use allPrograms as the source for the filter options, not allClasses
            let currentProgramData = allPrograms.filter(p => p.name === currentProgram);

            // 1. Grade Filter
            // Extract unique grade levels from the filtered program list
            const grades = [...new Set(currentProgramData.map(p => p.grade_level))].sort((a, b) => a - b);
            const gradeFilterEl = document.getElementById('grade-filter');
            gradeFilterEl.innerHTML = `<option value="">All Grades</option>`;
            grades.forEach(grade => {
                // Ensure grade comparison handles string/number mismatch if it occurs
                gradeFilterEl.innerHTML += `<option value="${grade}" ${grade == currentGrade ? 'selected' : ''}>Grade ${grade}</option>`;
            });


            // Filter program data by current grade if set, for populating section filters
            let sectionsSource = currentProgramData;
            if (currentGrade) {
                // Filter the sections based on the selected grade
                sectionsSource = currentProgramData.filter(p => p.grade_level == currentGrade);
            }

            // 2. Section Filter (Dynamically filtered by Program and Grade)
            const sectionFilterEl = document.getElementById('section-filter');
            // Extract unique sections from the filtered program list
            const sections = [...new Set(sectionsSource.map(p => p.section))].sort();

            sectionFilterEl.innerHTML = `<option value="">All Sections</option>`;
            sections.forEach(section => {
                sectionFilterEl.innerHTML += `<option value="${section}" ${section === currentSection ? 'selected' : ''}>${section}</option>`;
            });
        }

        /**
         * Renders or re-renders the FullCalendar view based on current filters.
         */
        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');

            // 1. Apply Filters
            const filteredClasses = allClasses.filter(c => {
                const programMatch = c.programs.name === currentProgram;
                // Loose comparison == is used as grade_level might be number in data
                const gradeMatch = !currentGrade || c.programs.grade_level == currentGrade; 
                const sectionMatch = !currentSection || c.programs.section === currentSection;

                return programMatch && gradeMatch && sectionMatch;
            });

            // 2. Map data to FullCalendar events
            const events = filteredClasses.map(c => ({
                id: c.id,
                title: `${c.subject} - ${c.rooms.name}`,
                start: c.start_time,
                end: c.end_time,
                allDay: false,
                extendedProps: {
                    program: `${c.programs.name} G${c.programs.grade_level} Sec ${c.programs.section}`,
                    teacher: c.teacher.full_name,
                    room: c.rooms.name
                },
                // Pink/Grey Theme Colors
                backgroundColor: c.programs.name === 'Junior High' ? '#ec4899' : '#6b7280', // Pink-500 or Gray-500
                borderColor: c.programs.name === 'Junior High' ? '#be185d' : '#374151' // Pink-700 or Gray-700
            }));

            // 3. Initialize/Update Calendar
            if (!calendar) {
                // Kiosk mode: editable is false, selectable is false
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'timeGridWeek',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'timeGridDay,timeGridWeek,dayGridMonth'
                    },
                    events: events,
                    nowIndicator: true,
                    editable: false, 
                    selectable: false,
                    slotMinTime: '07:00:00',
                    slotMaxTime: '18:00:00',
                    eventClick: handleEventClick,
                    // FIX: Ensure height is defined for the calendar to load correctly in a flex container
                    height: '100%', 
                    // Event drop/resize handlers are removed as editable is false
                });
                calendar.render();
            } else {
                calendar.setOption('events', events);
                calendar.refetchEvents();
            }
        }

        /**
         * Initializes the Leaflet map for the floor plan.
         */
        function initializeMap() {
            if (map) return;

            // Use a placeholder image for the floor plan
            const floorPlanImageUrl = 'https://placehold.co/1000x800/222222/cccccc?text=SCHOOL+FLOOR+PLAN';
            const imageBounds = [[-800, 0], [0, 1000]]; // Define map bounds for the image (0,0 is top-left)

            map = L.map('map', {
                crs: L.CRS.Simple,
                minZoom: -2,
                maxZoom: 2,
                center: [-400, 500], // Center of the image
                zoom: 0,
                maxBounds: imageBounds,
                maxBoundsViscosity: 1.0
            });

            L.imageOverlay(floorPlanImageUrl, imageBounds).addTo(map);

            // Add room markers (hotspots)
            allRooms.forEach(room => {
                // Ensure room has map coordinates for Leaflet
                if (room.map_coords && room.map_coords.lat && room.map_coords.lng) {
                    const marker = L.marker([room.map_coords.lat, room.map_coords.lng]).addTo(map);

                    // Find classes currently happening in this room
                    const now = new Date();
                    const currentClasses = allClasses.filter(c => {
                        const start = new Date(c.start_time);
                        const end = new Date(c.end_time);
                        const dayOfWeek = start.getDay(); // 0=Sun, 1=Mon...
                        return c.room_id === room.id && now >= start && now <= end && now.getDay() === dayOfWeek;
                    });

                    let popupContent = `<strong>${room.name} (${room.building} - Floor ${room.floor})</strong><br>`;

                    if (currentClasses.length > 0) {
                        popupContent += `<hr class="my-1"><strong>CURRENTLY:</strong><br>`;
                        currentClasses.forEach(c => {
                             // Use the teacher name from the joined object (c.teacher.full_name) 
                             const teacherName = c.teacher ? c.teacher.full_name : 'N/A';
                             popupContent += `<div>${c.subject} (G${c.programs.grade_level}) - ${teacherName}</div>`;
                        });
                    } else {
                        popupContent += `<hr class="my-1"><span class="text-green-600">Room is currently Free.</span>`;
                    }

                    marker.bindPopup(popupContent).openPopup();
                } else {
                    console.warn(`Room ${room.name} is missing map coordinates.`);
                }
            });
            map.fitBounds(imageBounds); // Zoom to fit the image
        }

        // ====================================================================
        // GEMINI ASSISTANT FUNCTIONS
        // ====================================================================

        /**
         * Renders the chat history into the modal.
         */
        function renderChat() {
            const chatHistoryEl = document.getElementById('chat-history');
            chatHistoryEl.innerHTML = '';
            
            chatHistory.forEach(message => {
                const isUser = message.role === 'user';
                const text = message.parts[0].text;
                
                const messageEl = document.createElement('div');
                messageEl.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
                
                const bubbleEl = document.createElement('div');
                bubbleEl.className = `p-3 rounded-xl max-w-[80%] shadow-lg text-sm`;

                if (isUser) {
                    bubbleEl.className += ' bg-pink-600 text-white rounded-br-none';
                } else {
                    bubbleEl.className += ' bg-blue-900 text-blue-100 rounded-bl-none';
                }

                // Simple Markdown to HTML conversion for basic formatting (bold/italics)
                let formattedText = text;
                // Basic bold
                formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Basic italics
                formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
                
                bubbleEl.innerHTML = formattedText.replace(/\n/g, '<br>');

                messageEl.appendChild(bubbleEl);
                chatHistoryEl.appendChild(messageEl);
            });
            
            // Scroll to the bottom
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }

        /**
         * Handles sending a message, updates history, and calls the Gemini API.
         */
        async function handleSendMessage(e) {
            e.preventDefault();
            const inputEl = document.getElementById('chat-input');
            const sendButton = document.getElementById('chat-send-button');
            const chatHistoryEl = document.getElementById('chat-history');
            const userQuery = inputEl.value.trim();

            if (!userQuery) return;

            // Trim chat history to prevent context window overflow (max 10 messages total)
            const MAX_HISTORY_LENGTH = 10; 
            if (chatHistory.length > MAX_HISTORY_LENGTH) {
                 // Keep the initial welcome message, and the last few turns
                 chatHistory = [chatHistory[0], ...chatHistory.slice(-(MAX_HISTORY_LENGTH - 1))];
            }


            // 1. Add user message to history and UI
            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });
            renderChat();
            inputEl.value = '';

            // 2. Disable input and show loading
            sendButton.disabled = true;
            sendButton.textContent = 'Thinking...';
            chatHistoryEl.innerHTML += `
                <div id="loading-indicator" class="flex justify-start">
                    <div class="bg-blue-900 text-blue-100 p-3 rounded-xl rounded-bl-none max-w-[80%] shadow-lg text-sm italic opacity-70">
                        STEC-Buddy is typing...
                    </div>
                </div>`;
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;

            try {
                // 3. Call the API
                const systemInstruction = `You are **STEC-Buddy**, the BCSTEC Kiosk Assistant. Your role is to provide helpful, concise, and friendly information about school schedules, rooms, and general school facts. Be polite and keep answers brief. When appropriate, use Google Search to find current, relevant information. Your primary schedule data is static, so defer to general knowledge or mock information for schedule-related queries.`;
                const geminiResponse = await sendMessageToGemini(userQuery, systemInstruction);

                // 4. Add model response to history
                chatHistory.push({ role: "model", parts: [{ text: geminiResponse.text }] });
                
                // 5. Re-render chat
                renderChat();

            } catch (error) {
                console.error('Gemini API Error:', error);
                chatHistory.push({ 
                    role: "model", 
                    parts: [{ text: "Sorry, I encountered an error while processing your request. Please try again." }] 
                });
                renderChat();
            } finally {
                // 6. Re-enable input
                document.getElementById('loading-indicator')?.remove();
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
            }
        }

        /**
         * Sends a message to the Gemini API with exponential backoff.
         */
        async function sendMessageToGemini(userQuery, systemInstruction, maxRetries = 5) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            const payload = {
                contents: chatHistory,
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                }
            };
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            return { text };
                        } else {
                            console.error(`Attempt ${attempt + 1}: API call successful but returned no text content. Full result:`, result);
                            throw new Error("API response successful but content was empty.");
                        }
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        // Rate limit error, retry with exponential backoff
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    } else {
                        // Log other non-success status codes
                        const errorBody = await response.text();
                        console.error(`Attempt ${attempt + 1}: API call failed with status: ${response.status}. Response Body:`, errorBody);
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Failed to get response from Gemini API after multiple retries.");
        }


        // ====================================================================
        // EVENT HANDLERS
        // ====================================================================

        /**
         * Handles FullCalendar event click (show details modal only).
         */
        function handleEventClick(info) {
            const event = info.event;
            const classData = allClasses.find(c => c.id === event.id);

            if (!classData) return;

            // Populate Detail Modal
            document.getElementById('detail-subject').textContent = event.title.split(' - ')[0];
            document.getElementById('detail-teacher').textContent = event.extendedProps.teacher;
            document.getElementById('detail-room').textContent = event.extendedProps.room;
            document.getElementById('detail-time').textContent = `${event.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${event.end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} (${event.start.toDateString()})`;
            document.getElementById('detail-program').textContent = event.extendedProps.program;

            // Hide Edit Form permanently
            document.getElementById('edit-form').classList.add('hidden');
            
            // Show modal
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('detail-modal').classList.add('flex');
        }

        // Program Tab Click
        document.querySelectorAll('.program-tab').forEach(button => {
            button.addEventListener('click', (e) => {
                currentProgram = e.target.dataset.program;
                currentGrade = null;
                currentSection = null;
                
                document.querySelectorAll('.program-tab').forEach(btn => {
                    const isSelected = btn.dataset.program === currentProgram;
                    
                    // Permanent dark theme classes
                    btn.classList.remove('bg-pink-900', 'text-pink-100', 'bg-gray-700', 'text-gray-300', 'hover:bg-pink-800', 'hover:bg-gray-600');

                    if (isSelected) {
                        btn.classList.add('bg-pink-900', 'text-pink-100', 'hover:bg-pink-800');
                    } else {
                        btn.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                    }
                });
                renderFilters();
            });
        });

        // Grade Filter Change
        document.getElementById('grade-filter').addEventListener('change', (e) => {
            currentGrade = e.target.value || null;
            currentSection = null;
            renderFilters();
        });
        
        // Section Filter Change
        document.getElementById('section-filter').addEventListener('change', (e) => {
            currentSection = e.target.value || null;
        });

        // See Schedule Button Click
        document.getElementById('see-schedule-button').addEventListener('click', () => {
            renderCalendar();
        });

        // Assistant Button Click
        document.getElementById('ask-assistant-button').addEventListener('click', () => {
            renderChat();
            document.getElementById('assistant-modal').classList.remove('hidden');
            document.getElementById('assistant-modal').classList.add('flex');
        });

        // Close Assistant Modal
        document.getElementById('close-assistant-modal').addEventListener('click', () => {
            document.getElementById('assistant-modal').classList.add('hidden');
            document.getElementById('assistant-modal').classList.remove('flex');
        });

        // Chat Form Submission
        document.getElementById('chat-form').addEventListener('submit', handleSendMessage);

        // Map Toggle Button
        document.getElementById('map-toggle-button').addEventListener('click', () => {
            const calendarView = document.getElementById('calendar-view');
            const mapView = document.getElementById('map-view');

            if (mapView.classList.contains('hidden')) {
                calendarView.classList.add('hidden');
                mapView.classList.remove('hidden');
                document.getElementById('map-toggle-button').textContent = 'View Schedule';
                if (map) map.invalidateSize();
            } else {
                mapView.classList.add('hidden');
                calendarView.classList.remove('hidden');
                document.getElementById('map-toggle-button').textContent = 'View Floor Plan';
            }
        });

        // Close Detail Modal
        document.getElementById('close-detail-modal').addEventListener('click', () => {
            document.getElementById('detail-modal').classList.add('hidden');
            document.getElementById('detail-modal').classList.remove('flex');
        });


        // ====================================================================
        // INITIALIZATION
        // ====================================================================

        async function init() {
            // No need for dark mode listener as it's permanently dark.

            // No need to update auth status or sign in
            document.getElementById('user-status').textContent = 'Kiosk View Mode';
            
            await fetchStaticData();
            setupRealtimeListener();

            // Set initial colors for program tabs (using permanent dark classes)
            document.querySelector('.program-tab[data-program="Junior High"]').classList.add('bg-pink-900', 'text-pink-100');
            document.querySelector('.program-tab[data-program="Senior High"]').classList.add('bg-gray-700', 'text-gray-300');
        }

        window.onload = init;

    </script>
</body>
</html>
