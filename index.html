<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BCSTEC Smart Kiosk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap');
        
        body { 
            font-family: 'Outfit', sans-serif; 
            background: #020617;
            color: #f8fafc;
            height: 100dvh;
            overflow: hidden;
            font-size: 16px; /* Base size for readability */
        }

        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-card { background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* Larger touch targets for mobile */
        .sidebar-link {
            transition: all 0.2s ease;
            min-height: 64px;
        }
        
        .sidebar-link.active {
            color: #f472b6;
            background: rgba(244, 114, 182, 0.1);
        }

        /* FullCalendar Mobile Fixes */
        .fc { font-size: 0.85rem; background: transparent; }
        .fc-toolbar-title { font-size: 1.1rem !important; font-weight: 800; }
        .fc-button { padding: 0.6rem !important; text-transform: uppercase; font-size: 0.7rem !important; font-weight: 700; }

        input, select, button {
            min-height: 48px; /* Minimum touch target size */
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col">

    <!-- Header: Bigger & Bolder -->
    <header class="h-20 flex items-center justify-between px-6 border-b border-white/10 bg-slate-950 z-[100] shrink-0">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-black tracking-tighter text-white">BCSTEC</h1>
            <div id="admin-indicator" class="hidden items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-500/20 border border-emerald-500/40">
                <span id="admin-name-display" class="text-xs font-bold text-emerald-400 uppercase tracking-widest">Admin</span>
            </div>
        </div>
        
        <div class="flex items-center gap-5">
            <div class="text-right">
                <p id="current-time" class="text-xl font-black text-white leading-none">00:00</p>
                <p id="current-date" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Loading...</p>
            </div>
            <button id="login-btn" onclick="handleAuthAction()" class="w-12 h-12 rounded-2xl glass-card flex items-center justify-center text-slate-300">
                <i class="fa-solid fa-fingerprint text-xl"></i>
            </button>
        </div>
    </header>

    <!-- Main Scene: Large Content Area -->
    <main class="flex-grow relative overflow-hidden bg-slate-950">
        
        <!-- Tab: Map (Simplified Big Interface) -->
        <div id="tab-map" class="tab-content absolute inset-0 p-4">
            <div class="h-full w-full glass-card rounded-[2rem] flex flex-col items-center justify-center border-2 border-white/5">
                <i class="fa-solid fa-map-location-dot text-6xl text-slate-700 mb-4"></i>
                <p class="text-sm font-bold text-slate-500 uppercase tracking-widest">Campus Interactive Map</p>
            </div>
        </div>

        <!-- Tab: Calendar (Bigger Controls) -->
        <div id="tab-calendar" class="tab-content absolute inset-0 hidden p-4 flex flex-col">
            <div class="flex gap-3 mb-4 overflow-x-auto no-scrollbar py-2">
                <button onclick="setDept('JHS')" class="dept-btn px-6 py-3 bg-slate-800 rounded-2xl text-xs font-bold text-white uppercase border-2 border-transparent active:border-pink-500">Junior High</button>
                <button onclick="setDept('SHS')" class="dept-btn px-6 py-3 bg-slate-800 rounded-2xl text-xs font-bold text-white uppercase border-2 border-transparent active:border-pink-500">Senior High</button>
            </div>
            <div class="flex-grow glass-card rounded-[2rem] overflow-hidden p-2 shadow-2xl">
                <div id="calendar" class="h-full"></div>
            </div>
        </div>

        <!-- Tab: Directory (Large Profile Cards) -->
        <div id="tab-directory" class="tab-content absolute inset-0 hidden p-4 overflow-y-auto">
            <div id="staff-grid" class="space-y-4 pb-24">
                <!-- Cards here will be big and tappable -->
            </div>
        </div>

        <!-- Tab: Manage (Big Management List) -->
        <div id="tab-manage" class="tab-content absolute inset-0 hidden p-4 overflow-y-auto">
            <div class="flex items-center justify-between mb-6 px-2">
                <h2 class="text-lg font-black uppercase tracking-widest text-white">Management</h2>
                <button onclick="openClassModal()" class="px-5 py-3 bg-emerald-600 rounded-xl text-xs font-bold text-white uppercase">Add New</button>
            </div>
            <div id="manage-list" class="space-y-4 pb-24">
                <!-- Large Management Items -->
            </div>
        </div>

        <!-- Action Buttons -->
        <button id="admin-fab" onclick="openClassModal()" class="hidden fixed bottom-28 right-6 w-16 h-16 bg-emerald-500 rounded-2xl shadow-2xl shadow-emerald-500/40 z-[90] text-white text-2xl">
            <i class="fa-solid fa-plus"></i>
        </button>
        
        <button onclick="openAIModal()" class="fixed bottom-28 left-6 w-16 h-16 bg-indigo-600 rounded-2xl shadow-2xl shadow-indigo-500/40 z-[90] text-white text-2xl">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
        </button>
    </main>

    <!-- Bottom Nav: Tall & Accessible -->
    <nav class="h-24 glass z-[100] px-4 flex items-center justify-around shrink-0 pb-4">
        <button onclick="switchTab('map')" id="nav-map" class="sidebar-link flex flex-col items-center justify-center gap-1 active">
            <i class="fa-solid fa-map text-2xl"></i>
            <span class="text-[11px] font-extrabold uppercase tracking-tight">Map</span>
        </button>
        <button onclick="switchTab('calendar')" id="nav-calendar" class="sidebar-link flex flex-col items-center justify-center gap-1">
            <i class="fa-solid fa-clock text-2xl"></i>
            <span class="text-[11px] font-extrabold uppercase tracking-tight">Schedules</span>
        </button>
        <button onclick="switchTab('directory')" id="nav-directory" class="sidebar-link flex flex-col items-center justify-center gap-1">
            <i class="fa-solid fa-user-group text-2xl"></i>
            <span class="text-[11px] font-extrabold uppercase tracking-tight">Staff</span>
        </button>
        <button onclick="switchTab('manage')" id="nav-manage" class="hidden sidebar-link flex flex-col items-center justify-center gap-1 text-pink-400">
            <i class="fa-solid fa-screwdriver-wrench text-2xl"></i>
            <span class="text-[11px] font-extrabold uppercase tracking-tight">Admin</span>
        </button>
    </nav>

    <!-- Modal: Login (Large Inputs) -->
    <div id="modal-login" class="fixed inset-0 bg-slate-950/98 hidden items-center justify-center z-[200] p-6 backdrop-blur-2xl">
        <div class="w-full max-w-sm glass rounded-[2.5rem] p-10 border-2 border-white/10">
            <h3 class="text-2xl font-black text-white mb-8 uppercase tracking-widest text-center">Auth Portal</h3>
            <form onsubmit="doLogin(event)" class="space-y-5">
                <input type="text" id="in-name" placeholder="Staff Name" class="w-full bg-slate-900 border-2 border-white/5 p-5 rounded-2xl text-white text-base font-bold focus:border-pink-500 outline-none">
                <input type="password" id="in-pass" placeholder="Passkey" class="w-full bg-slate-900 border-2 border-white/5 p-5 rounded-2xl text-white text-base font-bold focus:border-pink-500 outline-none">
                <button type="submit" class="w-full py-5 bg-pink-600 rounded-2xl text-xs font-black text-white uppercase tracking-widest mt-4">Login</button>
                <button type="button" onclick="closeModal('modal-login')" class="w-full py-3 text-slate-500 text-xs font-bold uppercase mt-2">Dismiss</button>
            </form>
        </div>
    </div>

    <!-- Modal: AI (Full Screen Mobile) -->
    <div id="modal-ai" class="fixed inset-0 bg-slate-950 hidden flex-col z-[200] backdrop-blur-3xl">
        <div class="flex-grow flex flex-col max-w-3xl mx-auto w-full">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-indigo-600/10">
                <div class="flex items-center gap-4">
                    <i class="fa-solid fa-sparkles text-indigo-400 text-2xl"></i>
                    <span class="text-lg font-black uppercase tracking-widest text-white">Campus AI</span>
                </div>
                <button onclick="closeModal('modal-ai')" class="text-slate-400 p-2"><i class="fa-solid fa-times text-2xl"></i></button>
            </div>
            <div id="ai-chat" class="flex-grow p-6 overflow-y-auto space-y-6"></div>
            <form onsubmit="askAI(event)" class="p-6 bg-slate-900 border-t border-white/10 flex gap-3">
                <input type="text" id="ai-input" placeholder="Type message..." class="flex-grow bg-slate-950 border-2 border-white/5 px-6 py-4 rounded-2xl text-base text-white outline-none focus:border-indigo-500">
                <button class="w-16 h-16 bg-indigo-600 rounded-2xl text-white text-xl"><i class="fa-solid fa-paper-plane"></i></button>
            </form>
        </div>
    </div>

    <!-- Modal: Class Entry -->
    <div id="modal-class" class="fixed inset-0 bg-slate-950/98 hidden items-center justify-center z-[200] p-6 backdrop-blur-2xl">
        <div class="w-full max-w-md glass rounded-[2.5rem] p-8 border-2 border-white/10 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-black text-white mb-8 uppercase tracking-widest text-center">New Schedule</h3>
            <form onsubmit="saveClass(event)" class="space-y-5">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Subject Name</label>
                    <input type="text" id="f-subject" required class="w-full bg-slate-900 border-2 border-white/5 p-4 rounded-xl text-white font-bold">
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <select id="f-program" class="w-full bg-slate-900 border-2 border-white/5 p-4 rounded-xl text-white font-bold"></select>
                    <select id="f-teacher" class="w-full bg-slate-900 border-2 border-white/5 p-4 rounded-xl text-white font-bold"></select>
                    <select id="f-room" class="w-full bg-slate-900 border-2 border-white/5 p-4 rounded-xl text-white font-bold"></select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="time" id="f-start" class="w-full bg-slate-900 border-2 border-white/5 p-4 rounded-xl text-white font-bold">
                    <input type="time" id="f-end" class="w-full bg-slate-900 border-2 border-white/5 p-4 rounded-xl text-white font-bold">
                </div>
                <button type="submit" class="w-full py-5 bg-emerald-600 rounded-2xl text-xs font-black text-white uppercase tracking-widest shadow-xl shadow-emerald-600/20">Create Record</button>
                <button type="button" onclick="closeModal('modal-class')" class="w-full py-3 text-slate-500 text-xs font-bold uppercase">Discard</button>
            </form>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyDVWjA31ScGRW7mWIDbO9TsLC_9vtL9uFs";
        const SUPABASE_URL = "https://nwwkgmlnnlsmbjrvcnaj.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53d2tnbWxubmxzbWJqcnZjbmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTYxMDcsImV4cCI6MjA4MTM3MjEwN30.Stz0PC0XAxlAkmHpWxY9reIeVzbXaDKuiSUOrJ4HB7Y"; // Key needed
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let state = {
            user: JSON.parse(localStorage.getItem('user_session')),
            activeTab: 'map',
            calendar: null,
            dept: 'JHS'
        };

        function switchTab(id) {
            state.activeTab = id;
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            document.getElementById(`nav-${id}`).classList.add('active');

            if(id === 'calendar') setTimeout(initCalendar, 100);
            if(id === 'directory') loadStaff();
            if(id === 'manage') loadManagement();
        }

        function openModal(id) { document.getElementById(id).classList.replace('hidden', 'flex'); }
        function closeModal(id) { document.getElementById(id).classList.replace('flex', 'hidden'); }

        async function doLogin(e) {
            e.preventDefault();
            const name = document.getElementById('in-name').value;
            const pass = document.getElementById('in-pass').value;
            const { data } = await supabase.from('profiles').select('*').eq('full_name', name).eq('passkey', pass).single();
            if(data) {
                state.user = data;
                localStorage.setItem('user_session', JSON.stringify(data));
                closeModal('modal-login');
                syncUI();
            } else {
                alert("Login failed. Check credentials.");
            }
        }

        function handleAuthAction() {
            if(state.user) {
                if(confirm("Sign out of system?")) {
                    localStorage.removeItem('user_session');
                    location.reload();
                }
            } else {
                openModal('modal-login');
            }
        }

        function syncUI() {
            const ind = document.getElementById('admin-indicator');
            const navManage = document.getElementById('nav-manage');
            const fab = document.getElementById('admin-fab');
            const logBtn = document.getElementById('login-btn');
            
            if(state.user && (state.user.role === 'admin' || state.user.role === 'teacher')) {
                ind.classList.replace('hidden', 'flex');
                document.getElementById('admin-name-display').textContent = state.user.full_name.split(' ')[0];
                navManage.classList.remove('hidden');
                fab.classList.remove('hidden');
                logBtn.classList.add('bg-emerald-600', 'text-white');
            } else {
                ind.classList.replace('flex', 'hidden');
                navManage.classList.add('hidden');
                fab.classList.add('hidden');
            }
        }

        async function loadStaff() {
            const { data } = await supabase.from('profiles').select('*').order('full_name');
            const grid = document.getElementById('staff-grid');
            grid.innerHTML = data.map(s => `
                <div class="glass-card p-6 rounded-[1.5rem] flex items-center gap-6 shadow-lg border-l-8 border-pink-500/50">
                    <div class="w-16 h-16 rounded-2xl bg-slate-900 border border-white/10 flex items-center justify-center font-black text-pink-500 text-2xl shadow-inner">
                        ${s.full_name[0]}
                    </div>
                    <div>
                        <p class="text-lg font-black text-white">${s.full_name}</p>
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">${s.role}</p>
                    </div>
                </div>
            `).join('');
        }

        async function loadManagement() {
            const { data } = await supabase.from('classes').select('*, profiles(full_name), rooms(name), programs(section)');
            const list = document.getElementById('manage-list');
            list.innerHTML = data.map(c => `
                <div class="glass-card p-6 rounded-[2rem] flex justify-between items-center border-l-8 border-pink-600 bg-slate-900/40">
                    <div class="space-y-1">
                        <p class="text-lg font-black text-white">${c.subject}</p>
                        <p class="text-xs font-bold text-slate-400 uppercase">${c.programs?.section} | Room ${c.rooms?.name}</p>
                        <p class="text-[11px] font-bold text-slate-500 uppercase tracking-widest">${c.profiles?.full_name}</p>
                    </div>
                    <button onclick="deleteClass('${c.id}')" class="w-14 h-14 bg-rose-500/10 rounded-2xl flex items-center justify-center text-rose-500 text-xl border border-rose-500/20">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        async function deleteClass(id) {
            if(!confirm("Permantently delete this schedule record?")) return;
            await supabase.from('classes').delete().eq('id', id);
            loadManagement();
            if(state.calendar) state.calendar.refetchEvents();
        }

        function initCalendar() {
            const el = document.getElementById('calendar');
            if (state.calendar) state.calendar.destroy();
            state.calendar = new FullCalendar.Calendar(el, {
                initialView: 'timeGridDay',
                headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },
                slotMinTime: '07:00:00', slotMaxTime: '18:00:00',
                allDaySlot: false, height: '100%',
                nowIndicator: true,
                events: async (info, success) => {
                    const { data } = await supabase.from('classes').select('*, rooms(name)');
                    success(data.map(c => {
                        const d = new Date();
                        d.setDate(d.getDate() + (c.day_of_week - d.getDay()));
                        return { title: `${c.subject} (${c.rooms?.name})`, start: `${d.toISOString().split('T')[0]}T${c.start_time}`, end: `${d.toISOString().split('T')[0]}T${c.end_time}`, color: '#ec4899' };
                    }));
                }
            });
            state.calendar.render();
        }

        async function askAI(e) {
            e.preventDefault();
            const box = document.getElementById('ai-chat');
            const input = document.getElementById('ai-input');
            const q = input.value;
            if(!q) return;
            box.innerHTML += `<div class="flex justify-end"><div class="bg-indigo-600 p-4 rounded-3xl rounded-tr-none text-base font-bold text-white max-w-[85%] shadow-xl">${q}</div></div>`;
            input.value = '';
            
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: q }] }] })
            });
            const data = await res.json();
            const txt = data.candidates[0].content.parts[0].text;
            box.innerHTML += `<div class="flex gap-4"><div class="w-10 h-10 rounded-xl bg-indigo-500/20 flex items-center justify-center text-indigo-400 shrink-0"><i class="fa-solid fa-sparkles"></i></div><div class="bg-slate-900 border border-white/10 p-5 rounded-3xl rounded-tl-none text-base text-slate-200 max-w-[85%] shadow-lg leading-relaxed">${txt}</div></div>`;
            box.scrollTop = box.scrollHeight;
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
            document.getElementById('current-date').textContent = now.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
        }

        async function openClassModal() {
            const [p, t, r] = await Promise.all([
                supabase.from('programs').select('*'),
                supabase.from('profiles').select('*'),
                supabase.from('rooms').select('*')
            ]);
            document.getElementById('f-program').innerHTML = p.data.map(x => `<option value="${x.id}">${x.section}</option>`).join('');
            document.getElementById('f-teacher').innerHTML = t.data.map(x => `<option value="${x.id}">${x.full_name}</option>`).join('');
            document.getElementById('f-room').innerHTML = r.data.map(x => `<option value="${x.id}">Room ${x.name}</option>`).join('');
            openModal('modal-class');
        }

        async function saveClass(e) {
            e.preventDefault();
            const payload = {
                subject: document.getElementById('f-subject').value,
                program_id: document.getElementById('f-program').value,
                teacher_id: document.getElementById('f-teacher').value,
                room_id: document.getElementById('f-room').value,
                day_of_week: 1, // Default Mon for demo
                start_time: document.getElementById('f-start').value,
                end_time: document.getElementById('f-end').value
            };
            await supabase.from('classes').insert(payload);
            closeModal('modal-class');
            loadManagement();
            if(state.calendar) state.calendar.refetchEvents();
        }

        function openAIModal() { openModal('modal-ai'); }

        window.onload = () => {
            syncUI();
            updateTime();
            setInterval(updateTime, 1000);
            switchTab('map');
        };
    </script>
</body>
</html>
