<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STEC Smart Kiosk | Bayawan City</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        :root {
            --primary: #ec4899;
            --bg-main: #111827;
            --bg-card: #1f2937;
        }

        body {
            background-color: var(--bg-main);
            color: #f9fafb;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .page-container {
            display: none;
            height: calc(100vh - 144px);
            width: 100%;
            overflow-y: auto;
            position: relative;
        }

        @media (min-width: 768px) {
            .page-container { height: calc(100vh - 72px); }
        }

        .page-container.active { display: block; }

        .interactive-btn {
            cursor: pointer !important;
            transition: transform 0.1s active, opacity 0.2s;
            touch-action: manipulation;
        }

        .interactive-btn:active { transform: scale(0.96); opacity: 0.8; }

        .modal-wrap {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(17, 24, 39, 0.95);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-wrap.active { display: flex; }

        .fc { 
            --fc-border-color: #374151;
            --fc-button-bg-color: #ec4899;
            --fc-button-border-color: #ec4899;
            height: 100% !important;
            background: #1f2937;
            border-radius: 1.5rem;
            padding: 1rem;
            font-size: 0.8rem;
            color: white;
        }

        #ai-chat-box {
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 350px;
            overflow-y: auto;
        }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 13px; line-height: 1.5; }
        .msg-ai { background: #1f2937; border: 1px solid #374151; align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg-user { background: #ec4899; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }

        select option { background-color: #111827; color: white; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="h-[72px] bg-gray-900 border-b border-gray-800 flex items-center justify-between px-6 z-[100] relative">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-pink-600 rounded-xl flex items-center justify-center shadow-lg">
                <i class="fa-solid fa-graduation-cap text-white"></i>
            </div>
            <div>
                <h1 class="font-extrabold text-sm tracking-tighter leading-none">STEC SMART KIOSK</h1>
                <p class="text-[9px] text-pink-500 font-bold mt-1 uppercase">Bayawan City Education</p>
            </div>
        </div>

        <nav class="hidden md:flex gap-1">
            <button onclick="router.navigate('map')" id="nav-map" class="nav-link px-4 py-2 rounded-lg text-xs font-bold text-pink-400 border-b-2 border-pink-400">CAMPUS MAP</button>
            <button onclick="router.navigate('schedule')" id="nav-schedule" class="nav-link px-4 py-2 rounded-lg text-xs font-bold text-gray-400">SCHEDULES</button>
            <button onclick="router.navigate('directory')" id="nav-directory" class="nav-link px-4 py-2 rounded-lg text-xs font-bold text-gray-400">DIRECTORY</button>
        </nav>

        <div class="flex items-center gap-2">
            <button onclick="ui.openModal('modal-ai')" class="interactive-btn px-4 py-2 bg-pink-600/10 border border-pink-500/30 rounded-xl text-[10px] font-black text-pink-500 uppercase tracking-widest">
                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> ASK STEC AI
            </button>
            <button onclick="ui.openModal('modal-login')" id="staff-auth-btn" class="interactive-btn w-10 h-10 bg-gray-800 border border-gray-700 rounded-xl flex items-center justify-center">
                <i class="fa-solid fa-id-badge"></i>
            </button>
        </div>
    </header>

    <main class="relative">
        <!-- PAGE: MAP -->
        <section id="page-map" class="page-container active p-4">
            <div class="w-full h-full bg-gray-900/50 border-2 border-dashed border-gray-800 rounded-[2rem] flex flex-col items-center justify-center text-center p-6">
                <i class="fa-solid fa-map-location-dot text-6xl text-gray-800 mb-4"></i>
                <h2 class="text-xl font-bold text-pink-500">Navigator</h2>
                <p class="text-gray-500 text-sm mt-2">Campus facilities and room layout</p>
            </div>
        </section>

        <!-- PAGE: SCHEDULE -->
        <section id="page-schedule" class="page-container p-4">
            <div class="flex flex-col lg:flex-row gap-4 h-full">
                <div class="w-full lg:w-72 flex flex-col gap-4">
                    <!-- PUBLIC FILTERS -->
                    <div class="bg-gray-900 p-5 rounded-3xl border border-gray-800">
                        <label class="text-[10px] font-black text-pink-500 uppercase tracking-widest mb-3 block">Level Select</label>
                        <div class="flex gap-2 mb-4">
                            <button onclick="app.setLevel('Junior High')" id="lvl-jhs" class="flex-1 py-3 bg-pink-600 rounded-2xl text-xs font-bold">JHS</button>
                            <button onclick="app.setLevel('Senior High')" id="lvl-shs" class="flex-1 py-3 bg-gray-800 rounded-2xl text-xs font-bold">SHS</button>
                        </div>

                        <div class="space-y-3">
                            <div>
                                <label class="text-[9px] font-bold text-gray-500 ml-1 mb-1 block uppercase">Grade Level</label>
                                <select id="filter-grade" onchange="app.updateFilterSections()" class="w-full bg-gray-950 border border-gray-800 p-3 rounded-xl text-xs outline-none focus:border-pink-500 text-white">
                                    <option value="">All Grades</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[9px] font-bold text-gray-500 ml-1 mb-1 block uppercase">Section</label>
                                <select id="filter-section" onchange="app.applyFilter()" class="w-full bg-gray-950 border border-gray-800 p-3 rounded-xl text-xs outline-none focus:border-pink-500 text-white">
                                    <option value="">All Sections</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="admin-tools" class="hidden">
                        <div class="bg-pink-900/10 p-5 rounded-3xl border border-pink-500/30">
                            <label class="text-[10px] font-black text-pink-500 uppercase mb-3 block">Faculty Controls</label>
                            <button onclick="ui.openModal('modal-add')" class="w-full py-4 bg-pink-600 rounded-2xl text-xs font-bold text-white mb-2 interactive-btn shadow-lg">
                                <i class="fa-solid fa-plus-circle mr-2"></i> POST SESSION
                            </button>
                            <button onclick="app.loadUserPosts()" class="w-full py-4 bg-gray-800 rounded-2xl text-xs font-bold text-gray-300 interactive-btn border border-gray-700">
                                <i class="fa-solid fa-list-check mr-2"></i> MANAGE POSTS
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex-1 min-h-[450px]">
                    <div id="calendar"></div>
                </div>
            </div>
        </section>

        <!-- PAGE: DIRECTORY -->
        <section id="page-directory" class="page-container p-4">
            <div id="staff-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        </section>
    </main>

    <!-- FOOTER MOBILE TABS -->
    <footer class="md:hidden fixed bottom-0 left-0 right-0 h-[72px] bg-gray-900 border-t border-gray-800 flex items-center justify-around z-[100]">
        <button onclick="router.navigate('map')" id="mob-map" class="mob-link flex flex-col items-center text-pink-500"><i class="fa-solid fa-map"></i><span class="text-[8px] font-bold mt-1">MAP</span></button>
        <button onclick="router.navigate('schedule')" id="mob-schedule" class="mob-link flex flex-col items-center text-gray-500"><i class="fa-solid fa-calendar"></i><span class="text-[8px] font-bold mt-1">SCHED</span></button>
        <button onclick="router.navigate('directory')" id="mob-directory" class="mob-link flex flex-col items-center text-gray-500"><i class="fa-solid fa-users"></i><span class="text-[8px] font-bold mt-1">STAFF</span></button>
    </footer>

    <!-- MODAL: POST SESSION -->
    <div id="modal-add" class="modal-wrap">
        <div class="bg-gray-900 border border-gray-800 p-6 rounded-[2rem] w-full max-w-lg shadow-2xl relative">
            <button onclick="ui.closeModals()" class="absolute top-6 right-6 text-gray-500"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-xl font-black mb-6 text-pink-500">Create New Event</h3>
            <form onsubmit="app.createPost(event)" class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="text-[10px] font-bold text-gray-500 mb-1 ml-2 block uppercase">Event / Subject Name</label>
                    <input type="text" id="f-subject" placeholder="Enter title (e.g. Physics 1)" required class="w-full bg-gray-950 border border-gray-800 p-4 rounded-xl text-sm outline-none focus:border-pink-500 text-white">
                </div>
                
                <div>
                    <label class="text-[10px] font-bold text-gray-500 mb-1 ml-2 block uppercase">Grade Level</label>
                    <select id="f-grade" onchange="app.updateSectionOptions('f-grade', 'f-program')" required class="w-full bg-gray-950 border border-gray-800 p-4 rounded-xl text-sm outline-none focus:border-pink-500 text-white">
                        <option value="">Select Grade</option>
                    </select>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-gray-500 mb-1 ml-2 block uppercase">Section</label>
                    <select id="f-program" required class="w-full bg-gray-950 border border-gray-800 p-4 rounded-xl text-sm outline-none focus:border-pink-500 text-white">
                        <option value="">Select Section</option>
                    </select>
                </div>

                <div class="col-span-1">
                    <label class="text-[10px] font-bold text-gray-500 mb-1 ml-2 block uppercase">Room Location</label>
                    <select id="f-room" required class="w-full bg-gray-950 border border-gray-800 p-4 rounded-xl text-sm outline-none focus:border-pink-500 text-white"></select>
                </div>

                <div class="col-span-1">
                    <label class="text-[10px] font-bold text-gray-500 mb-1 ml-2 block uppercase">Date</label>
                    <input type="date" id="f-date" required class="w-full bg-gray-950 border border-gray-800 p-4 rounded-xl text-sm outline-none focus:border-pink-500 text-white">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-gray-500 mb-1 ml-2 block uppercase">Start Time</label>
                    <input type="time" id="f-start" required class="w-full bg-gray-950 border border-gray-800 p-4 rounded-xl text-sm outline-none focus:border-pink-500 text-white">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-500 mb-1 ml-2 block uppercase">End Time</label>
                    <input type="time" id="f-end" required class="w-full bg-gray-950 border border-gray-800 p-4 rounded-xl text-sm outline-none focus:border-pink-500 text-white">
                </div>
                
                <button type="submit" class="col-span-2 py-4 bg-pink-600 rounded-xl font-black tracking-widest mt-2 interactive-btn">PUBLISH TO KIOSK</button>
            </form>
        </div>
    </div>

    <!-- MODAL: MANAGE -->
    <div id="modal-manage" class="modal-wrap">
        <div class="bg-gray-900 border border-gray-800 p-6 rounded-[2rem] w-full max-w-md shadow-2xl relative">
            <button onclick="ui.closeModals()" class="absolute top-6 right-6 text-gray-500"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-xl font-black mb-4">Post Manager</h3>
            <div id="manage-list" class="space-y-2 max-h-80 overflow-y-auto pr-2"></div>
        </div>
    </div>

    <!-- MODAL: AI -->
    <div id="modal-ai" class="modal-wrap">
        <div class="bg-gray-900 border border-gray-800 rounded-[2.5rem] w-full max-w-lg shadow-2xl relative flex flex-col overflow-hidden max-h-[85vh]">
            <div class="p-5 bg-gray-800/50 flex justify-between items-center border-b border-gray-700">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-robot text-pink-500"></i>
                    <span class="font-black text-sm">STEC AI GUIDE</span>
                </div>
                <button onclick="ui.closeModals()"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="ai-chat-box" class="p-5 bg-gray-950/50 flex-1 overflow-y-auto">
                <div class="msg msg-ai">Welcome! I'm the STEC AI. Ask me about our curriculum, staff, or campus!</div>
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-800 flex gap-2">
                <input type="text" id="ai-input" placeholder="Ask anything about STEC..." class="flex-1 bg-gray-950 border border-gray-700 p-3 rounded-xl text-sm outline-none focus:border-pink-500 text-white" onkeydown="if(event.key==='Enter') ai.ask()">
                <button onclick="ai.ask()" class="w-12 h-12 bg-pink-600 rounded-xl flex items-center justify-center interactive-btn">
                    <i class="fa-solid fa-paper-plane text-white"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: LOGIN -->
    <div id="modal-login" class="modal-wrap">
        <div class="bg-gray-900 border border-gray-800 p-8 rounded-[2rem] w-full max-w-xs text-center relative shadow-2xl">
            <button onclick="ui.closeModals()" class="absolute top-4 right-4 text-gray-500"><i class="fa-solid fa-times"></i></button>
            <i class="fa-solid fa-id-badge text-4xl text-pink-500 mb-4"></i>
            <h3 class="text-xl font-bold mb-6">Verify Faculty</h3>
            <form onsubmit="app.login(event)" class="space-y-4 text-left">
                <input type="text" id="log-name" placeholder="Full Name" required class="w-full bg-gray-950 border border-gray-800 p-4 rounded-xl text-white outline-none">
                <input type="password" id="log-pass" placeholder="Authorization Key" required class="w-full bg-gray-950 border border-gray-800 p-4 rounded-xl text-white outline-none">
                <button type="submit" class="w-full py-4 bg-pink-600 rounded-xl font-black text-xs interactive-btn">LOGIN</button>
            </form>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyDRJAtJou8VfhSrf2JLppK8UVMIGMUHHac"; 
        const SUPA_URL = "https://nwwkgmlnnlsmbjrvcnaj.supabase.co";
        const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53d2tnbWxubmxzbWJqcnZjbmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTYxMDcsImV4cCI6MjA4MTM3MjEwN30.Stz0PC0XAxlAkmHpWxY9reIeVzbXaDKuiSUOrJ4HB7Y";
        const sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);

        const state = { 
            currentUser: null, 
            currentLevel: 'Junior High', 
            programs: [], 
            rooms: [], 
            calendar: null,
            filterGrade: '',
            filterSectionId: ''
        };

        const router = {
            navigate(pageId) {
                document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
                document.getElementById(`page-${pageId}`).classList.add('active');
                
                document.querySelectorAll('.nav-link').forEach(l => l.className = "nav-link px-4 py-2 rounded-lg text-xs font-bold text-gray-400");
                const nav = document.getElementById(`nav-${pageId}`);
                if (nav) nav.className = "nav-link px-4 py-2 rounded-lg text-xs font-bold text-pink-400 border-b-2 border-pink-400";

                document.querySelectorAll('.mob-link').forEach(l => l.classList.replace('text-pink-500', 'text-gray-500'));
                const mob = document.getElementById(`mob-${pageId}`);
                if (mob) mob.classList.replace('text-gray-500', 'text-pink-500');

                if (pageId === 'schedule') app.renderCalendar();
                if (pageId === 'directory') app.loadDirectory();
            }
        };

        const ui = {
            openModal(id) { 
                if(id === 'modal-add') app.populateDropdowns('f-grade', 'f-program', 'f-room');
                document.getElementById(id).classList.add('active'); 
            },
            closeModals() { document.querySelectorAll('.modal-wrap').forEach(m => m.classList.remove('active')); }
        };

        const ai = {
            async ask() {
                const q = document.getElementById('ai-input').value.trim();
                if (!q) return;
                const box = document.getElementById('ai-chat-box');
                box.innerHTML += `<div class="msg msg-user">${q}</div>`;
                document.getElementById('ai-input').value = '';
                box.scrollTop = box.scrollHeight;

                const sys = "You are the STEC AI Guide. Expert on STEM curriculum at Bayawan City Science and Technology Education Center. Be professional.";
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{parts: [{text: q}]}], systemInstruction: {parts: [{text: sys}]} })
                    });
                    const d = await res.json();
                    const txt = d.candidates?.[0]?.content?.parts?.[0]?.text || "System busy.";
                    const id = 'm'+Date.now();
                    box.innerHTML += `<div class="msg msg-ai"><div id="${id}">${txt}</div><button onclick="ai.speak('${id}')" class="text-[9px] font-bold text-pink-500 mt-2">LISTEN</button></div>`;
                    box.scrollTop = box.scrollHeight;
                } catch(e) { box.innerHTML += `<div class="msg msg-ai">Error.</div>`; }
            },
            async speak(id) {
                const t = document.getElementById(id).innerText;
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{parts: [{text: t}]}], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } }, model: "gemini-2.5-flash-preview-tts" })
                });
                const d = await res.json();
                const b64 = d.candidates[0].content.parts[0].inlineData.data;
                const blob = ai.pcmToWav(b64, 24000);
                new Audio(URL.createObjectURL(blob)).play();
            },
            pcmToWav(b, sr) {
                const s = atob(b), l = s.length, bytes = new Uint8Array(l);
                for (let i = 0; i < l; i++) bytes[i] = s.charCodeAt(i);
                const buf = new ArrayBuffer(44 + l), v = new DataView(buf);
                const str = (o, s) => { for(let i=0; i<s.length; i++) v.setUint8(o+i, s.charCodeAt(i)); };
                str(0, 'RIFF'); v.setUint32(4, 36+l, true); str(8, 'WAVE'); str(12, 'fmt '); v.setUint32(16, 16, true);
                v.setUint16(20, 1, true); v.setUint16(22, 1, true); v.setUint32(24, sr, true); v.setUint32(28, sr*2, true);
                v.setUint16(32, 2, true); v.setUint16(34, 16, true); str(36, 'data'); v.setUint32(40, l, true);
                for (let i = 0; i < l; i++) v.setUint8(44+i, bytes[i]);
                return new Blob([buf], { type: 'audio/wav' });
            }
        };

        const app = {
            async init() {
                const [p, r] = await Promise.all([
                    sb.from('programs').select('*'), 
                    sb.from('rooms').select('*')
                ]);
                state.programs = p.data || [];
                state.rooms = r.data || [];
                
                // Initial filter population
                app.populateDropdowns('filter-grade', 'filter-section');
            },
            populateDropdowns(gradeElId, sectionElId, roomElId = null) {
                // Filter by level name (Junior High or Senior High)
                const levelProgs = state.programs.filter(x => x.name === state.currentLevel);
                
                // Use grade_level column for grades
                const grades = [...new Set(levelProgs.map(p => p.grade_level))].filter(Boolean).sort();

                const gradeEl = document.getElementById(gradeElId);
                gradeEl.innerHTML = `<option value="">${gradeElId.includes('filter') ? 'All Grades' : 'Select Grade'}</option>` + 
                    grades.map(g => `<option value="${g}">${g}</option>`).join('');

                const sectionEl = document.getElementById(sectionElId);
                sectionEl.innerHTML = `<option value="">${sectionElId.includes('filter') ? 'All Sections' : 'Select Section'}</option>`;

                if(roomElId) {
                    const roomEl = document.getElementById(roomElId);
                    roomEl.innerHTML = state.rooms.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
                }
            },
            updateSectionOptions(gradeElId, sectionElId) {
                const gradeVal = document.getElementById(gradeElId).value;
                const levelProgs = state.programs.filter(x => x.name === state.currentLevel);
                
                let sections = [];
                if(gradeVal) {
                    // Filter sections by selected grade_level
                    sections = levelProgs.filter(p => p.grade_level === gradeVal);
                }

                const sectionEl = document.getElementById(sectionElId);
                sectionEl.innerHTML = `<option value="">${sectionElId.includes('filter') ? 'All Sections' : 'Select Section'}</option>` + 
                    sections.map(s => `<option value="${s.id}">${s.section || 'Unspecified'}</option>`).join('');
            },
            updateFilterSections() {
                app.updateSectionOptions('filter-grade', 'filter-section');
                app.applyFilter();
            },
            applyFilter() {
                state.filterGrade = document.getElementById('filter-grade').value;
                state.filterSectionId = document.getElementById('filter-section').value;
                if(state.calendar) state.calendar.refetchEvents();
            },
            async login(e) {
                e.preventDefault();
                const { data } = await sb.from('profiles').select('*').eq('full_name', document.getElementById('log-name').value).eq('passkey', document.getElementById('log-pass').value).single();
                if (data) {
                    state.currentUser = data;
                    document.getElementById('admin-tools').classList.remove('hidden');
                    document.getElementById('staff-auth-btn').innerHTML = `<i class="fa-solid fa-check text-pink-500"></i>`;
                    ui.closeModals();
                }
            },
            setLevel(l) {
                state.currentLevel = l;
                document.getElementById('lvl-jhs').className = l === 'Junior High' ? "flex-1 py-3 bg-pink-600 rounded-2xl text-xs font-bold" : "flex-1 py-3 bg-gray-800 rounded-2xl text-xs font-bold";
                document.getElementById('lvl-shs').className = l === 'Senior High' ? "flex-1 py-3 bg-pink-600 rounded-2xl text-xs font-bold" : "flex-1 py-3 bg-gray-800 rounded-2xl text-xs font-bold";
                
                app.populateDropdowns('filter-grade', 'filter-section');
                app.applyFilter();
                
                if (state.calendar) state.calendar.refetchEvents();
            },
            renderCalendar() {
                const el = document.getElementById('calendar');
                if (state.calendar) { state.calendar.updateSize(); state.calendar.refetchEvents(); return; }
                state.calendar = new FullCalendar.Calendar(el, {
                    initialView: window.innerWidth < 768 ? 'listDay' : 'timeGridDay',
                    allDaySlot: false,
                    slotMinTime: '07:00:00',
                    slotMaxTime: '18:00:00',
                    events: async (i, s) => {
                        let programIds = [];
                        
                        if(state.filterSectionId) {
                            programIds = [state.filterSectionId];
                        } else if (state.filterGrade) {
                            programIds = state.programs
                                .filter(x => x.name === state.currentLevel && x.grade_level === state.filterGrade)
                                .map(x => x.id);
                        } else {
                            programIds = state.programs.filter(x => x.name === state.currentLevel).map(x => x.id);
                        }

                        if(programIds.length === 0) { s([]); return; }

                        const { data } = await sb.from('classes').select('*, rooms(name)').in('program_id', programIds);
                        s((data || []).map(c => ({ 
                            id: c.id, 
                            title: `${c.subject} (${c.rooms?.name})`, 
                            start: c.start_time, 
                            end: c.end_time 
                        })));
                    }
                });
                state.calendar.render();
            },
            async createPost(e) {
                e.preventDefault();
                const post = {
                    subject: document.getElementById('f-subject').value,
                    program_id: document.getElementById('f-program').value,
                    room_id: document.getElementById('f-room').value,
                    start_time: `${document.getElementById('f-date').value}T${document.getElementById('f-start').value}:00`,
                    end_time: `${document.getElementById('f-date').value}T${document.getElementById('f-end').value}:00`,
                    profile_id: state.currentUser.id
                };
                const { error } = await sb.from('classes').insert(post);
                if (!error) { ui.closeModals(); state.calendar.refetchEvents(); }
            },
            async loadUserPosts() {
                const { data } = await sb.from('classes').select('*').eq('profile_id', state.currentUser.id);
                document.getElementById('manage-list').innerHTML = (data || []).map(p => `
                    <div class="p-4 bg-gray-800 rounded-2xl border border-gray-700 flex justify-between items-center">
                        <div><h5 class="text-xs font-bold">${p.subject}</h5><p class="text-[9px] text-gray-500">${p.start_time.split('T')[0]}</p></div>
                        <button onclick="app.deletePost('${p.id}')" class="text-pink-500"><i class="fa-solid fa-trash"></i></button>
                    </div>`).join('');
                ui.openModal('modal-manage');
            },
            async deletePost(id) {
                if (confirm("Delete this?")) {
                    await sb.from('classes').delete().eq('id', id);
                    app.loadUserPosts();
                    state.calendar.refetchEvents();
                }
            },
            async loadDirectory() {
                const { data } = await sb.from('profiles').select('*').order('full_name');
                document.getElementById('staff-grid').innerHTML = (data || []).map(p => `
                    <div class="bg-gray-900 border border-gray-800 p-5 rounded-3xl flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-gray-800 flex items-center justify-center font-black text-pink-500 border border-gray-700">${p.full_name[0]}</div>
                        <div class="truncate"><h4 class="text-sm font-bold text-white">${p.full_name}</h4><p class="text-[10px] text-gray-500 uppercase">${p.role || 'Personnel'}</p></div>
                    </div>`).join('');
            }
        };

        window.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
    </html>
