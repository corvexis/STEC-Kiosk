<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>STEC Smart Kiosk</title>
    
    <!-- Styling & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Outfit:wght@300;400;600;800&display=swap');
        
        :root {
            --brand-primary: #ec4899;
            --brand-secondary: #8b5cf6;
            --bg-deep: #020617;
            --glass-bg: rgba(15, 23, 42, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background: radial-gradient(circle at top right, #1e1b4b, #020617);
            color: #f8fafc;
            height: 100vh;
            height: 100svh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin: 0;
        }

        h1, h2, h3 { font-family: 'Space Grotesk', sans-serif; }

        .glass { background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); }
        .glass-card { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
        
        .scroll-container {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .sidebar-link.active { color: white; background: linear-gradient(to right, rgba(236, 72, 153, 0.2), transparent); }
        
        @media (max-width: 1023px) {
            .sidebar-link.active { border-top: 3px solid var(--brand-primary); color: var(--brand-primary); background: transparent; }
            nav { padding-bottom: env(safe-area-inset-bottom); }
        }

        .fc { --fc-border-color: rgba(255, 255, 255, 0.1); font-size: 0.85rem; }
        .fc-event { border: none !important; background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)) !important; border-radius: 6px !important; padding: 2px 4px; }

        .level-btn.active { background-color: var(--brand-primary) !important; color: white !important; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3); }

        .chat-bubble-bot { border-bottom-left-radius: 2px; background: #1e293b; border: 1px solid rgba(255,255,255,0.05); }
        .chat-bubble-user { border-bottom-right-radius: 2px; background: linear-gradient(135deg, #ec4899, #8b5cf6); }

        .typing-dot { width: 5px; height: 5px; background: #94a3b8; border-radius: 50%; animation: blink 1.4s infinite both; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 80%, 100% { opacity: 0; } 40% { opacity: 1; } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="lg:flex-row">

    <!-- NAVIGATION BAR -->
    <nav class="order-last lg:order-first w-full lg:w-72 flex lg:flex-col glass border-t lg:border-t-0 lg:border-r border-white/5 z-50 shrink-0">
        <div class="hidden lg:block p-8 mb-4">
            <h1 class="text-2xl font-black tracking-tighter bg-gradient-to-r from-pink-500 to-violet-500 bg-clip-text text-transparent">STEC KIOSK</h1>
        </div>

        <div class="flex flex-row lg:flex-col flex-grow justify-around lg:justify-start lg:space-y-2 px-1 lg:px-3 py-1 lg:py-0">
            <button type="button" onclick="switchTab('map', event)" data-tab="map" class="sidebar-link active flex-1 lg:flex-none p-3 lg:p-4 rounded-xl flex flex-col lg:flex-row items-center gap-1 lg:gap-4 text-slate-400">
                <i class="fa-solid fa-map-location-dot text-lg lg:text-xl"></i>
                <span class="text-[9px] lg:text-sm font-bold lg:font-medium">Map</span>
            </button>
            <button type="button" onclick="switchTab('calendar', event)" data-tab="calendar" class="sidebar-link flex-1 lg:flex-none p-3 lg:p-4 rounded-xl flex flex-col lg:flex-row items-center gap-1 lg:gap-4 text-slate-400">
                <i class="fa-solid fa-calendar-days text-lg lg:text-xl"></i>
                <span class="text-[9px] lg:text-sm font-bold lg:font-medium">Schedules</span>
            </button>
            <button type="button" onclick="switchTab('directory', event)" data-tab="directory" class="sidebar-link flex-1 lg:flex-none p-3 lg:p-4 rounded-xl flex flex-col lg:flex-row items-center gap-1 lg:gap-4 text-slate-400">
                <i class="fa-solid fa-address-book text-lg lg:text-xl"></i>
                <span class="text-[9px] lg:text-sm font-bold lg:font-medium">Directory</span>
            </button>
            <button type="button" onclick="openAIDrawer()" class="lg:hidden flex-1 p-3 rounded-xl flex flex-col items-center gap-1 text-indigo-400">
                <i class="fa-solid fa-wand-magic-sparkles text-lg"></i>
                <span class="text-[9px] font-bold">AI</span>
            </button>
        </div>

        <!-- DESKTOP FOOTER -->
        <div class="hidden lg:block p-4 mt-auto">
            <div id="admin-controls" class="hidden mb-4 space-y-2">
                <div class="grid grid-cols-2 gap-2">
                    <button type="button" onclick="openClassModal()" class="p-3 bg-emerald-600/20 border border-emerald-500/30 rounded-xl text-emerald-400 text-[10px] font-bold uppercase hover:bg-emerald-600/30 transition-all">
                        <i class="fa-solid fa-plus-circle mb-1 block text-base"></i>Add
                    </button>
                    <button type="button" onclick="openDeleteModal()" class="p-3 bg-red-600/20 border border-red-500/30 rounded-xl text-red-400 text-[10px] font-bold uppercase hover:bg-red-600/30 transition-all">
                        <i class="fa-solid fa-trash-can mb-1 block text-base"></i>Delete
                    </button>
                </div>
            </div>
            <div class="glass-card p-4 rounded-2xl mb-4">
                <p class="text-[10px] font-black text-pink-500 uppercase mb-3 tracking-widest">Global Level</p>
                <div class="flex p-1 bg-slate-900/50 rounded-lg mb-2">
                    <button onclick="setSchoolLevel('Junior High')" class="level-btn active flex-1 py-1 text-[10px] font-bold rounded-md transition-all" data-level="Junior High">JHS</button>
                    <button onclick="setSchoolLevel('Senior High')" class="level-btn flex-1 py-1 text-[10px] font-bold rounded-md transition-all" data-level="Senior High">SHS</button>
                </div>
                <select id="program-filter" onchange="filterCalendarByProgram(this.value)" class="w-full bg-slate-800 border-none rounded-lg p-2 text-[10px] text-white outline-none ring-1 ring-white/10">
                    <option value="all">All Sections</option>
                </select>
            </div>
            <button type="button" onclick="openAIDrawer()" class="w-full p-4 bg-gradient-to-br from-indigo-600 to-violet-700 rounded-2xl flex items-center justify-center gap-3 font-bold hover:scale-[1.02] transition shadow-xl">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <span>Ask Assistant</span>
            </button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="flex-grow flex flex-col relative overflow-hidden h-full">
        <header class="h-16 lg:h-20 flex items-center justify-between px-4 lg:px-8 border-b border-white/5 bg-slate-950/40 backdrop-blur-md shrink-0">
            <div>
                <h2 id="view-title" class="text-base lg:text-xl font-bold text-white">Campus Navigator</h2>
                <p id="view-subtitle" class="hidden lg:block text-[10px] text-slate-500 uppercase font-black tracking-widest">Real-time Information System</p>
            </div>

            <div class="flex items-center gap-4">
                <div class="hidden sm:flex flex-col items-end">
                    <span id="current-time" class="text-sm lg:text-lg font-bold text-white">12:00 PM</span>
                </div>
                <button type="button" id="login-trigger" class="px-3 py-2 lg:px-5 lg:py-2.5 glass-card rounded-xl text-[10px] lg:text-xs font-bold hover:text-pink-500 transition">
                    <i class="fa-solid fa-lock lg:mr-2"></i><span class="hidden lg:inline">Admin Access</span>
                </button>
            </div>
        </header>

        <div class="flex-grow relative">
            <!-- MAP TAB -->
            <div id="tab-map" class="tab-content absolute inset-0 p-4 lg:p-8 scroll-container">
                <div class="glass-card h-full min-h-[400px] rounded-3xl border-dashed border-2 border-white/10 flex flex-col items-center justify-center">
                    <i class="fa-solid fa-map-location-dot text-6xl text-slate-700 mb-4"></i>
                    <p class="text-slate-500 text-sm font-medium">Interactive Map rendering...</p>
                </div>
            </div>

            <!-- CALENDAR TAB -->
            <div id="tab-calendar" class="tab-content absolute inset-0 hidden p-2 lg:p-4 flex flex-col">
                <div class="lg:hidden flex gap-2 mb-2 overflow-x-auto no-scrollbar shrink-0">
                    <button onclick="setSchoolLevel('Junior High')" class="level-btn active whitespace-nowrap px-4 py-1.5 bg-slate-800 rounded-full text-[10px] font-bold border border-white/5" data-level="Junior High">JHS</button>
                    <button onclick="setSchoolLevel('Senior High')" class="level-btn whitespace-nowrap px-4 py-1.5 bg-slate-800 rounded-full text-[10px] font-bold border border-white/5" data-level="Senior High">SHS</button>
                </div>
                <div class="flex-grow glass-card rounded-2xl lg:rounded-3xl p-1 lg:p-4 overflow-hidden">
                    <div id="calendar" class="h-full"></div>
                </div>
            </div>

            <!-- DIRECTORY TAB -->
            <div id="tab-directory" class="tab-content absolute inset-0 hidden p-4 lg:p-8 scroll-container">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
                    <h3 class="text-2xl font-bold text-white">Personnel Directory</h3>
                    <input type="text" id="dir-search" oninput="filterDirectory()" placeholder="Search names..." class="w-full sm:w-64 bg-slate-800 border-none rounded-xl px-4 py-2 text-sm text-white ring-1 ring-white/10">
                </div>
                <div id="directory-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20"></div>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    <div id="modal-login" class="fixed inset-0 bg-slate-950/95 backdrop-blur-xl hidden items-center justify-center z-[100] p-4">
        <div class="w-full max-w-sm glass p-8 rounded-[32px] relative">
            <button onclick="closeModals()" class="absolute top-6 right-6 text-slate-500 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="text-xl font-bold text-white text-center mb-6">Staff Verification</h3>
            <form class="space-y-4" onsubmit="handleLogin(event)">
                <input type="text" id="login-name" placeholder="Full Name" required class="w-full bg-slate-800 p-4 rounded-xl text-white outline-none ring-1 ring-white/5 focus:ring-pink-500">
                <input type="password" id="login-pass" placeholder="Passkey" required class="w-full bg-slate-800 p-4 rounded-xl text-white outline-none ring-1 ring-white/5 focus:ring-pink-500">
                <button type="submit" class="w-full py-4 bg-pink-600 rounded-xl font-bold shadow-lg hover:bg-pink-700 transition">Unlock Admin Tools</button>
            </form>
        </div>
    </div>

    <div id="modal-class" class="fixed inset-0 bg-slate-950/95 backdrop-blur-xl hidden items-center justify-center z-[110] p-4">
        <div class="w-full max-w-lg glass p-8 rounded-[32px] relative scroll-container max-h-[90vh]">
            <button onclick="closeModals()" class="absolute top-6 right-6 text-slate-500 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="text-xl font-bold text-white mb-6">Schedule Class Session</h3>
            <form id="form-class" class="grid grid-cols-1 sm:grid-cols-2 gap-4" onsubmit="handleClassSubmit(event)">
                <div class="sm:col-span-2">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Subject</label>
                    <input type="text" id="class-subject" required class="w-full bg-slate-800 p-3 rounded-xl text-white outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Section</label>
                    <select id="class-program" required class="w-full bg-slate-800 p-3 rounded-xl text-white outline-none"></select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Room</label>
                    <select id="class-room" required class="w-full bg-slate-800 p-3 rounded-xl text-white outline-none"></select>
                </div>
                <div class="sm:col-span-2">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Date</label>
                    <input type="date" id="class-date" required class="w-full bg-slate-800 p-3 rounded-xl text-white outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Start</label>
                    <input type="time" id="class-start" required class="w-full bg-slate-800 p-3 rounded-xl text-white outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">End</label>
                    <input type="time" id="class-end" required class="w-full bg-slate-800 p-3 rounded-xl text-white outline-none">
                </div>
                <button type="submit" class="sm:col-span-2 mt-4 py-4 bg-emerald-600 rounded-xl font-bold hover:bg-emerald-700 transition">Publish to Kiosk</button>
            </form>
        </div>
    </div>

    <div id="modal-delete" class="fixed inset-0 bg-slate-950/95 backdrop-blur-xl hidden items-center justify-center z-[110] p-4">
        <div class="w-full max-w-lg glass p-8 rounded-[32px] relative flex flex-col max-h-[85vh]">
            <button onclick="closeModals()" class="absolute top-6 right-6 text-slate-500 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="text-xl font-bold text-white mb-2">Manage Sessions</h3>
            <p class="text-xs text-slate-500 mb-6 uppercase tracking-widest font-bold">Removal is permanent</p>
            <div id="delete-list" class="flex-grow overflow-y-auto space-y-3 pr-2 scroll-container"></div>
            <button onclick="closeModals()" class="mt-6 w-full py-4 bg-slate-800 rounded-xl text-sm font-bold">Close Manager</button>
        </div>
    </div>

    <div id="modal-ai" class="fixed inset-0 bg-slate-950/40 hidden justify-end z-[120]">
        <div class="w-full max-w-md glass flex flex-col h-full shadow-2xl animate-in slide-in-from-right duration-300">
            <div class="p-6 border-b border-white/5 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center text-white"><i class="fa-solid fa-robot"></i></div>
                    <div><h3 class="font-bold text-white text-sm">STEC Assistant</h3><p class="text-[10px] text-emerald-500">Live Context Access</p></div>
                </div>
                <button onclick="closeModals()" class="text-slate-500 p-2 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="chat-box" class="flex-grow overflow-y-auto p-6 flex flex-col gap-4 scroll-container bg-slate-950/20">
                <div class="chat-bubble-bot p-4 rounded-2xl text-sm self-start max-w-[85%] text-slate-300">
                    Welcome! I'm the STEC Campus AI. Ask me about schedules, rooms, or teachers!
                </div>
            </div>
            <form id="form-ai" class="p-4 bg-slate-950 border-t border-white/5 flex gap-2" onsubmit="handleAIChat(event)">
                <input type="text" id="ai-input" placeholder="Ask a question..." class="flex-grow bg-slate-800 rounded-xl px-4 py-3 text-sm text-white outline-none border border-transparent focus:border-indigo-500">
                <button type="submit" class="w-12 h-12 bg-indigo-600 rounded-xl text-white hover:bg-indigo-700 transition flex items-center justify-center"><i class="fa-solid fa-paper-plane"></i></button>
            </form>
        </div>
    </div>

    <script>
        const apiKey = ""; // Runtime provides this
        const CONFIG = {
            URL: "https://nwwkgmlnnlsmbjrvcnaj.supabase.co",
            KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53d2tnbWxubmxzbWJqcnZjbmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTYxMDcsImV4cCI6MjA4MTM3MjEwN30.Stz0PC0XAxlAkmHpWxY9reIeVzbXaDKuiSUOrJ4HB7Y"
        };

        const supabase = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
        
        let state = {
            user: null,
            calendar: null,
            level: 'Junior High',
            activeProgramId: 'all',
            allProfiles: [],
            allPrograms: []
        };

        // UI CORE
        function switchTab(id, event) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            const target = document.getElementById(`tab-${id}`);
            if(target) target.classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            if(event) event.currentTarget.classList.add('active');
            
            const titles = { map: 'Campus Navigator', calendar: 'Class Schedules', directory: 'Personnel Directory' };
            document.getElementById('view-title').textContent = titles[id];
            
            if(id === 'calendar') renderCalendar();
            if(id === 'directory') loadDirectory();
        }

        async function setSchoolLevel(l) {
            state.level = l;
            document.querySelectorAll('.level-btn').forEach(b => b.classList.toggle('active', b.getAttribute('data-level') === l));
            
            // Re-populate sections dropdown
            const filtered = state.allPrograms.filter(p => p.name === l);
            const select = document.getElementById('program-filter');
            select.innerHTML = '<option value="all">All Sections</option>' + 
                filtered.map(p => `<option value="${p.id}">${p.grade_level}-${p.section}</option>`).join('');
            
            state.activeProgramId = 'all';
            if(state.calendar) state.calendar.refetchEvents();
        }

        function filterCalendarByProgram(id) {
            state.activeProgramId = id;
            if(state.calendar) state.calendar.refetchEvents();
        }

        // CALENDAR
        function renderCalendar() {
            const el = document.getElementById('calendar');
            const isMobile = window.innerWidth < 1024;
            if (state.calendar) {
                state.calendar.updateSize();
                state.calendar.changeView(isMobile ? 'listDay' : 'timeGridDay');
                state.calendar.refetchEvents();
                return;
            }
            state.calendar = new FullCalendar.Calendar(el, {
                initialView: isMobile ? 'listDay' : 'timeGridDay',
                headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
                height: '100%',
                allDaySlot: false,
                slotMinTime: '07:00:00', slotMaxTime: '18:00:00',
                events: async (info, success, failure) => {
                    let query = supabase.from('classes').select('*, profiles(full_name), rooms(name), programs(name, grade_level, section)');
                    
                    if(state.activeProgramId !== 'all') {
                        query = query.eq('program_id', state.activeProgramId);
                    } else {
                        // Get all program IDs for current level
                        const levelPrograms = state.allPrograms.filter(p => p.name === state.level).map(p => p.id);
                        if(levelPrograms.length > 0) query = query.in('program_id', levelPrograms);
                    }

                    const { data, error } = await query;
                    if(error) return failure(error);

                    success((data || []).map(c => ({
                        id: c.id,
                        title: `${c.subject} - ${c.rooms?.name}`,
                        start: c.start_time,
                        end: c.end_time,
                        extendedProps: { teacher: c.profiles?.full_name }
                    })));
                }
            });
            state.calendar.render();
        }

        // DIRECTORY
        async function loadDirectory() {
            const { data } = await supabase.from('profiles').select('*').order('full_name');
            state.allProfiles = data || [];
            displayDirectory(state.allProfiles);
        }

        function displayDirectory(list) {
            document.getElementById('directory-grid').innerHTML = list.map(p => `
                <div class="glass-card p-5 rounded-3xl flex items-center gap-4 border border-white/5 hover:border-pink-500/30 transition-all">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-pink-500/10 to-violet-500/10 flex items-center justify-center text-pink-500 font-bold border border-pink-500/20">${p.full_name[0]}</div>
                    <div class="min-w-0">
                        <div class="text-sm font-bold text-white truncate">${p.full_name}</div>
                        <div class="text-[9px] text-slate-500 uppercase tracking-widest font-black">${p.role || 'Faculty'}</div>
                    </div>
                </div>
            `).join('');
        }

        function filterDirectory() {
            const q = document.getElementById('dir-search').value.toLowerCase();
            displayDirectory(state.allProfiles.filter(p => p.full_name.toLowerCase().includes(q)));
        }

        // AUTH & ADMIN
        async function handleLogin(e) {
            e.preventDefault();
            const { data } = await supabase.from('profiles').select('*')
                .eq('full_name', document.getElementById('login-name').value)
                .eq('passkey', document.getElementById('login-pass').value).single();
            
            if (data) {
                state.user = data;
                closeModals();
                document.getElementById('admin-controls').classList.remove('hidden');
                document.getElementById('login-trigger').innerHTML = `<i class="fa-solid fa-user-check mr-2"></i> Verified`;
                document.getElementById('login-trigger').classList.add('text-emerald-400');
            } else {
                alert("Credentials not recognized.");
            }
        }

        async function openClassModal() {
            const [progRes, roomRes] = await Promise.all([
                supabase.from('programs').select('*'),
                supabase.from('rooms').select('*')
            ]);
            document.getElementById('class-program').innerHTML = (progRes.data || []).map(p => `<option value="${p.id}">${p.name}: ${p.grade_level}-${p.section}</option>`).join('');
            document.getElementById('class-room').innerHTML = (roomRes.data || []).map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            document.getElementById('modal-class').classList.replace('hidden', 'flex');
        }

        async function handleClassSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('class-date').value;
            const { error } = await supabase.from('classes').insert([{
                subject: document.getElementById('class-subject').value,
                program_id: document.getElementById('class-program').value,
                room_id: document.getElementById('class-room').value,
                teacher_id: state.user.id,
                start_time: `${date}T${document.getElementById('class-start').value}:00Z`,
                end_time: `${date}T${document.getElementById('class-end').value}:00Z`
            }]);
            if(!error) { closeModals(); if(state.calendar) state.calendar.refetchEvents(); }
        }

        async function openDeleteModal() {
            if(!state.user) return;
            document.getElementById('modal-delete').classList.replace('hidden', 'flex');
            const { data } = await supabase.from('classes').select('*, rooms(name)').eq('teacher_id', state.user.id);
            document.getElementById('delete-list').innerHTML = (data || []).map(c => `
                <div class="glass-card p-4 rounded-2xl flex justify-between items-center">
                    <div class="min-w-0 pr-4">
                        <div class="text-sm font-bold text-white truncate">${c.subject}</div>
                        <div class="text-[9px] text-slate-500 uppercase">Room ${c.rooms?.name} | ${new Date(c.start_time).toLocaleDateString()}</div>
                    </div>
                    <button onclick="deleteClass('${c.id}')" class="w-10 h-10 bg-red-500/10 text-red-500 rounded-xl hover:bg-red-500 hover:text-white transition-all"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            `).join('');
        }

        async function deleteClass(id) {
            await supabase.from('classes').delete().eq('id', id);
            openDeleteModal();
            if(state.calendar) state.calendar.refetchEvents();
        }

        // AI ASSISTANT
        async function handleAIChat(e) {
            e.preventDefault();
            const input = document.getElementById('ai-input');
            const box = document.getElementById('chat-box');
            const val = input.value.trim();
            if(!val) return;

            input.value = "";
            box.innerHTML += `<div class="chat-bubble-user p-4 rounded-2xl text-sm self-end max-w-[85%] text-white">${val}</div>`;
            box.scrollTop = box.scrollHeight;

            const typing = document.createElement('div');
            typing.className = "chat-bubble-bot p-4 rounded-2xl text-sm self-start flex gap-1 items-center";
            typing.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            box.appendChild(typing);
            box.scrollTop = box.scrollHeight;

            const fetchWithRetry = async (query, retries = 0) => {
                const delays = [1000, 2000, 4000, 8000, 16000];
                try {
                    const { data: sched } = await supabase.from('classes').select('*, profiles(full_name), rooms(name)');
                    const context = sched.map(s => `${s.subject} with ${s.profiles?.full_name} in ${s.rooms?.name}`).join(", ");
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: query }] }],
                            systemInstruction: { parts: [{ text: `You are the STEC Campus AI. Today's schedules: ${context}. Answer questions about STEC campus life, rooms, and schedules briefly.` }] }
                        })
                    });
                    if(!response.ok) throw new Error();
                    return await response.json();
                } catch (e) {
                    if(retries < 5) {
                        await new Promise(r => setTimeout(r, delays[retries]));
                        return fetchWithRetry(query, retries + 1);
                    }
                    throw e;
                }
            };

            try {
                const res = await fetchWithRetry(val);
                typing.remove();
                const txt = res.candidates?.[0]?.content?.parts?.[0]?.text || "I'm not sure how to answer that right now.";
                box.innerHTML += `<div class="chat-bubble-bot p-4 rounded-2xl text-sm self-start max-w-[85%] text-slate-300 border border-white/5">${txt}</div>`;
            } catch {
                typing.remove();
                box.innerHTML += `<div class="chat-bubble-bot p-4 rounded-2xl text-sm self-start max-w-[85%] text-red-400">Connection error.</div>`;
            }
            box.scrollTop = box.scrollHeight;
        }

        function openAIDrawer() { document.getElementById('modal-ai').classList.replace('hidden', 'flex'); }
        function closeModals() { document.querySelectorAll('.fixed').forEach(m => m.classList.add('hidden')); }

        window.onload = async () => {
            setInterval(() => { document.getElementById('current-time').textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }, 1000);
            document.getElementById('login-trigger').onclick = () => document.getElementById('modal-login').classList.replace('hidden', 'flex');
            
            const { data } = await supabase.from('programs').select('*');
            state.allPrograms = data || [];
            
            setSchoolLevel('Junior High');
            switchTab('map');
        };

        window.onresize = () => { if(state.calendar) state.calendar.updateSize(); };
    </script>
</body>
</html>
