<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>STEC Smart Kiosk v2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --accent: #00f2ff;
            --accent-glow: rgba(0, 242, 255, 0.4);
            --bg-dark: #030712;
            --card-bg: rgba(15, 23, 42, 0.6);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(30, 58, 138, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(131, 24, 67, 0.15) 0%, transparent 50%);
            color: #f8fafc;
            height: 100vh;
            overflow: hidden;
            margin: 0;
        }

        .cyber-glass {
            background: var(--card-bg);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .nav-active {
            color: var(--accent);
            text-shadow: 0 0 15px var(--accent-glow);
            border-bottom: 2px solid var(--accent);
        }

        .tab-content {
            display: none;
            height: 100%;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fc { --fc-border-color: rgba(255,255,255,0.05); }
        .fc-toolbar-title { font-size: 1.1rem !important; font-weight: 800 !important; }
        .fc-event { 
            background: linear-gradient(135deg, #0ea5e9, #8b5cf6) !important;
            border: none !important;
            border-radius: 4px !important;
            padding: 2px 4px;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        .btn-hover { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover:active { transform: scale(0.95); }

        #ai-status-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body class="flex flex-col">

    <!-- GLOBAL TOP NAV -->
    <header class="h-20 shrink-0 flex items-center justify-between px-6 lg:px-12 z-50">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20">
                <i class="fa-solid fa-microchip text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-extrabold tracking-tight text-white leading-none">STEC SMART KIOSK</h1>
                <p class="text-[10px] text-cyan-400 font-bold tracking-[0.2em] mt-1">S.T.E.C. NAVIGATOR v2.5</p>
            </div>
        </div>

        <nav class="hidden md:flex items-center gap-8">
            <button onclick="ui.switchTab('map')" id="nav-map" class="nav-active py-2 text-sm font-bold uppercase tracking-widest transition-all">Campus Map</button>
            <button onclick="ui.switchTab('schedule')" id="nav-schedule" class="text-slate-400 hover:text-white py-2 text-sm font-bold uppercase tracking-widest transition-all">Schedules</button>
            <button onclick="ui.switchTab('directory')" id="nav-directory" class="text-slate-400 hover:text-white py-2 text-sm font-bold uppercase tracking-widest transition-all">Directory</button>
        </nav>

        <div class="flex items-center gap-3">
            <div class="text-right mr-4 hidden sm:block">
                <p id="clock" class="text-lg font-bold text-white leading-none">12:00 PM</p>
                <p id="date" class="text-[9px] text-slate-500 font-bold uppercase mt-1">Dec 26, 2025</p>
            </div>
            <button onclick="ui.openModal('modal-login')" id="admin-trigger" class="px-4 py-2 cyber-glass rounded-xl text-xs font-bold hover:bg-white/5 btn-hover">
                <i class="fa-solid fa-shield-halved mr-2 text-cyan-400"></i> STAFF
            </button>
        </div>
    </header>

    <!-- MAIN VIEWPORT -->
    <main class="flex-grow relative px-4 lg:px-10 pb-24 md:pb-6 overflow-hidden">
        
        <!-- MAP TAB -->
        <section id="tab-map" class="tab-content active pt-4">
            <div class="cyber-glass flex-grow rounded-[2rem] relative overflow-hidden group">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10"></div>
                <!-- Placeholder for Map Canvas -->
                <div class="absolute inset-0 flex flex-col items-center justify-center gap-4">
                    <div class="relative">
                        <i class="fa-solid fa-earth-asia text-9xl text-cyan-500/10"></i>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i class="fa-solid fa-location-dot text-4xl text-cyan-500"></i>
                        </div>
                    </div>
                    <div class="text-center">
                        <h3 class="text-2xl font-black text-white">INTERACTIVE CAMPUS MAP</h3>
                        <p class="text-slate-500 text-sm mt-1">Tap a building to see current classes and staff presence</p>
                    </div>
                    <div class="flex gap-4 mt-4">
                        <button class="px-6 py-3 bg-white/5 rounded-2xl border border-white/10 text-xs font-bold hover:bg-white/10 btn-hover">BUILDING A (JHS)</button>
                        <button class="px-6 py-3 bg-white/5 rounded-2xl border border-white/10 text-xs font-bold hover:bg-white/10 btn-hover">BUILDING B (SHS)</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- SCHEDULE TAB -->
        <section id="tab-schedule" class="tab-content pt-4">
            <div class="flex flex-col md:flex-row gap-6 h-full">
                <!-- Sidebar controls -->
                <div class="w-full md:w-64 shrink-0 space-y-4">
                    <div class="cyber-glass p-5 rounded-[2rem]">
                        <h4 class="text-[10px] font-black text-cyan-400 uppercase tracking-[0.2em] mb-4">Level Toggle</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="app.setLevel('Junior High')" id="lvl-jhs" class="py-3 bg-cyan-500 rounded-2xl text-xs font-extrabold text-white shadow-lg shadow-cyan-500/20 btn-hover">JHS</button>
                            <button onclick="app.setLevel('Senior High')" id="lvl-shs" class="py-3 bg-white/5 rounded-2xl text-xs font-extrabold text-slate-400 border border-white/5 btn-hover">SHS</button>
                        </div>
                    </div>
                    <div id="admin-actions" class="hidden animate-in fade-in slide-in-from-bottom-4">
                        <div class="cyber-glass p-5 rounded-[2rem] border-emerald-500/20">
                            <h4 class="text-[10px] font-black text-emerald-400 uppercase tracking-[0.2em] mb-4">Staff Desk</h4>
                            <div class="space-y-2">
                                <button onclick="ui.openModal('modal-class')" class="w-full py-3 bg-emerald-600 rounded-2xl text-xs font-bold text-white flex items-center justify-center gap-2 btn-hover">
                                    <i class="fa-solid fa-plus-circle"></i> NEW SESSION
                                </button>
                                <button onclick="app.loadUserSessions()" class="w-full py-3 bg-white/5 rounded-2xl text-xs font-bold text-slate-400 border border-white/5 btn-hover">
                                    MY POSTS
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Calendar -->
                <div class="flex-grow cyber-glass rounded-[2rem] p-6 overflow-hidden">
                    <div id="calendar" class="h-full"></div>
                </div>
            </div>
        </section>

        <!-- DIRECTORY TAB -->
        <section id="tab-directory" class="tab-content pt-4">
            <div class="flex flex-col h-full gap-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-white">PERSONNEL</h2>
                        <p class="text-slate-500 text-sm">Real-time status and contact directory</p>
                    </div>
                    <div class="relative group">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-cyan-400 transition-colors"></i>
                        <input type="text" oninput="app.searchDirectory(this.value)" placeholder="Search names, subjects, or roles..." 
                            class="w-full md:w-80 bg-white/5 border border-white/10 rounded-2xl pl-12 pr-4 py-4 text-sm text-white outline-none focus:ring-2 focus:ring-cyan-500/50 transition-all">
                    </div>
                </div>
                <div id="directory-grid" class="flex-grow overflow-y-auto custom-scrollbar grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pr-2 pb-10">
                    <!-- Cards injected here -->
                </div>
            </div>
        </section>

    </main>

    <!-- FLOATING AI ASSISTANT -->
    <div class="fixed bottom-6 right-6 md:bottom-10 md:right-10 z-[100]">
        <button onclick="ui.toggleAI()" class="w-16 h-16 md:w-20 md:h-20 bg-gradient-to-tr from-cyan-600 to-blue-700 rounded-[2rem] shadow-2xl shadow-cyan-500/40 flex items-center justify-center relative btn-hover group">
            <i class="fa-solid fa-wand-magic-sparkles text-2xl md:text-3xl text-white group-hover:rotate-12 transition-transform"></i>
            <div class="absolute -top-1 -right-1 w-4 h-4 bg-emerald-500 border-2 border-slate-900 rounded-full" id="ai-status-dot"></div>
        </button>

        <div id="ai-drawer" class="absolute bottom-24 right-0 w-[90vw] md:w-96 cyber-glass rounded-[2.5rem] flex-col overflow-hidden hidden">
            <div class="p-6 border-b border-white/5 flex items-center justify-between bg-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-cyan-500/20 flex items-center justify-center">
                        <i class="fa-solid fa-robot text-cyan-400"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm text-white">Assistant</h4>
                        <p class="text-[10px] text-cyan-400 font-bold tracking-widest uppercase">STEC Intelligence</p>
                    </div>
                </div>
                <button onclick="ui.toggleAI()" class="text-slate-500 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="ai-messages" class="h-80 overflow-y-auto p-6 flex flex-col gap-4 custom-scrollbar">
                <div class="bg-white/5 p-4 rounded-3xl rounded-bl-none text-xs text-slate-300 self-start max-w-[85%] border border-white/5">
                    Hello! I'm the STEC Campus Guide. How can I help you navigate today?
                </div>
            </div>
            <form onsubmit="app.handleAIChat(event)" class="p-4 bg-slate-950/50 flex gap-2">
                <input type="text" id="ai-input" placeholder="Ask anything..." class="flex-grow bg-white/5 border border-white/10 rounded-2xl px-4 py-3 text-sm text-white outline-none focus:border-cyan-500/50">
                <button type="submit" class="w-12 h-12 bg-cyan-600 rounded-2xl text-white btn-hover flex items-center justify-center">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- MOBILE NAV -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 h-20 cyber-glass border-t border-white/10 flex items-center justify-around px-4 z-[90]">
        <button onclick="ui.switchTab('map')" class="nav-btn-mob active flex flex-col items-center gap-1 text-cyan-500" data-tab="map">
            <i class="fa-solid fa-map"></i><span class="text-[9px] font-bold">MAP</span>
        </button>
        <button onclick="ui.switchTab('schedule')" class="nav-btn-mob flex flex-col items-center gap-1 text-slate-500" data-tab="schedule">
            <i class="fa-solid fa-calendar"></i><span class="text-[9px] font-bold">PLAN</span>
        </button>
        <button onclick="ui.switchTab('directory')" class="nav-btn-mob flex flex-col items-center gap-1 text-slate-500" data-tab="directory">
            <i class="fa-solid fa-users"></i><span class="text-[9px] font-bold">PEOPLE</span>
        </button>
    </div>

    <!-- MODAL: LOGIN -->
    <div id="modal-login" class="fixed inset-0 z-[200] bg-slate-950/90 backdrop-blur-md hidden items-center justify-center p-4">
        <div class="w-full max-w-sm cyber-glass p-8 rounded-[3rem] relative animate-in zoom-in duration-300">
            <button onclick="ui.closeModals()" class="absolute top-8 right-8 text-slate-500 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-cyan-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-cyan-500/20">
                    <i class="fa-solid fa-fingerprint text-3xl text-cyan-400"></i>
                </div>
                <h3 class="text-xl font-black text-white">Staff Verification</h3>
                <p class="text-xs text-slate-500 mt-1">Personnel access required</p>
            </div>
            <form onsubmit="app.login(event)" class="space-y-4">
                <input type="text" id="log-name" placeholder="Full Name" required class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl text-white outline-none focus:ring-2 focus:ring-cyan-500/50">
                <input type="password" id="log-pass" placeholder="Authorization Code" required class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl text-white outline-none focus:ring-2 focus:ring-cyan-500/50">
                <button type="submit" class="w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-700 rounded-2xl font-bold text-white shadow-xl shadow-cyan-900/40 btn-hover">VERIFY ACCESS</button>
            </form>
        </div>
    </div>

    <!-- MODAL: CREATE SESSION -->
    <div id="modal-class" class="fixed inset-0 z-[200] bg-slate-950/90 backdrop-blur-md hidden items-center justify-center p-4">
        <div class="w-full max-w-lg cyber-glass p-8 rounded-[3rem] relative overflow-y-auto max-h-[90vh] custom-scrollbar">
            <button onclick="ui.closeModals()" class="absolute top-8 right-8 text-slate-500 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-2xl font-black text-white mb-6">New Session Post</h3>
            <form onsubmit="app.createClass(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-[10px] font-bold text-cyan-400 uppercase tracking-widest mb-2 px-1">Subject / Event</label>
                    <input type="text" id="f-subject" required class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl text-white outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-cyan-400 uppercase tracking-widest mb-2 px-1">Program Section</label>
                    <select id="f-program" required class="w-full bg-slate-900 border border-white/10 p-4 rounded-2xl text-white outline-none"></select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-cyan-400 uppercase tracking-widest mb-2 px-1">Venue / Room</label>
                    <select id="f-room" required class="w-full bg-slate-900 border border-white/10 p-4 rounded-2xl text-white outline-none"></select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-[10px] font-bold text-cyan-400 uppercase tracking-widest mb-2 px-1">Date</label>
                    <input type="date" id="f-date" required class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl text-white outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-cyan-400 uppercase tracking-widest mb-2 px-1">Starts</label>
                    <input type="time" id="f-start" required class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl text-white outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-cyan-400 uppercase tracking-widest mb-2 px-1">Ends</label>
                    <input type="time" id="f-end" required class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl text-white outline-none">
                </div>
                <button type="submit" class="md:col-span-2 mt-4 py-5 bg-gradient-to-r from-emerald-600 to-cyan-700 rounded-[2rem] font-black text-white tracking-widest btn-hover">PUBLISH TO KIOSK</button>
            </form>
        </div>
    </div>

    <!-- MODAL: MY SESSIONS -->
    <div id="modal-manage" class="fixed inset-0 z-[200] bg-slate-950/90 backdrop-blur-md hidden items-center justify-center p-4">
        <div class="w-full max-w-md cyber-glass p-8 rounded-[3rem] relative flex flex-col max-h-[80vh]">
            <button onclick="ui.closeModals()" class="absolute top-8 right-8 text-slate-500 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-2xl font-black text-white mb-2">My Posts</h3>
            <p class="text-xs text-slate-500 mb-8 font-bold uppercase tracking-widest">Removal is irreversible</p>
            <div id="manage-list" class="space-y-3 overflow-y-auto custom-scrollbar pr-2 pb-4">
                <!-- Posts injected here -->
            </div>
        </div>
    </div>

    <script>
        // CORE CONFIG
        const apiKey = "";
        const SUPA_URL = "https://nwwkgmlnnlsmbjrvcnaj.supabase.co";
        const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53d2tnbWxubmxzbWJqcnZjbmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTYxMDcsImV4cCI6MjA4MTM3MjEwN30.Stz0PC0XAxlAkmHpWxY9reIeVzbXaDKuiSUOrJ4HB7Y";

        const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

        // APP STATE
        const state = {
            activeTab: 'map',
            level: 'Junior High',
            user: null,
            calendar: null,
            profiles: [],
            programs: [],
            rooms: []
        };

        // UI ACTIONS
        const ui = {
            switchTab(id) {
                state.activeTab = id;
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`tab-${id}`).classList.add('active');

                // Desktop Nav
                document.querySelectorAll('nav button').forEach(b => b.className = "text-slate-400 hover:text-white py-2 text-sm font-bold uppercase tracking-widest transition-all");
                const activeBtn = document.getElementById(`nav-${id}`);
                if (activeBtn) activeBtn.className = "nav-active py-2 text-sm font-bold uppercase tracking-widest transition-all";

                // Mobile Nav
                document.querySelectorAll('.nav-btn-mob').forEach(b => b.className = "nav-btn-mob flex flex-col items-center gap-1 text-slate-500");
                const activeMob = document.querySelector(`.nav-btn-mob[data-tab="${id}"]`);
                if (activeMob) activeMob.className = "nav-btn-mob flex flex-col items-center gap-1 text-cyan-500";

                if (id === 'schedule') app.renderCalendar();
                if (id === 'directory') app.loadDirectory();
            },
            openModal(id) {
                document.getElementById(id).classList.remove('hidden');
                document.getElementById(id).classList.add('flex');
            },
            closeModals() {
                document.querySelectorAll('.fixed.inset-0').forEach(m => {
                    m.classList.add('hidden');
                    m.classList.remove('flex');
                });
            },
            toggleAI() {
                const drawer = document.getElementById('ai-drawer');
                drawer.classList.toggle('hidden');
                drawer.classList.toggle('flex');
            }
        };

        // DATA LOGIC
        const app = {
            async init() {
                this.startClock();
                const { data: progs } = await supabase.from('programs').select('*').order('grade_level');
                const { data: rms } = await supabase.from('rooms').select('*').order('name');
                state.programs = progs || [];
                state.rooms = rms || [];

                // Fill dropdowns
                document.getElementById('f-program').innerHTML = state.programs.map(p => `<option value="${p.id}">${p.name} - ${p.grade_level}${p.section}</option>`).join('');
                document.getElementById('f-room').innerHTML = state.rooms.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            },

            startClock() {
                const update = () => {
                    const now = new Date();
                    document.getElementById('clock').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    document.getElementById('date').textContent = now.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
                };
                update();
                setInterval(update, 1000);
            },

            setLevel(lvl) {
                state.level = lvl;
                document.getElementById('lvl-jhs').className = (lvl === 'Junior High') ? "py-3 bg-cyan-500 rounded-2xl text-xs font-extrabold text-white shadow-lg shadow-cyan-500/20 btn-hover" : "py-3 bg-white/5 rounded-2xl text-xs font-extrabold text-slate-400 border border-white/5 btn-hover";
                document.getElementById('lvl-shs').className = (lvl === 'Senior High') ? "py-3 bg-cyan-500 rounded-2xl text-xs font-extrabold text-white shadow-lg shadow-cyan-500/20 btn-hover" : "py-3 bg-white/5 rounded-2xl text-xs font-extrabold text-slate-400 border border-white/5 btn-hover";
                if (state.calendar) state.calendar.refetchEvents();
            },

            async login(e) {
                e.preventDefault();
                const name = document.getElementById('log-name').value;
                const pass = document.getElementById('log-pass').value;

                const { data, error } = await supabase.from('profiles').select('*').eq('full_name', name).eq('passkey', pass).single();

                if (data) {
                    state.user = data;
                    ui.closeModals();
                    document.getElementById('admin-actions').classList.remove('hidden');
                    document.getElementById('admin-trigger').innerHTML = `<i class="fa-solid fa-circle-user mr-2 text-emerald-400"></i> ${data.full_name.split(' ')[0].toUpperCase()}`;
                    document.getElementById('admin-trigger').className = "px-4 py-2 cyber-glass rounded-xl text-xs font-bold text-emerald-400 border-emerald-500/20";
                } else {
                    alert("Unauthorized access code.");
                }
            },

            renderCalendar() {
                const el = document.getElementById('calendar');
                if (state.calendar) {
                    state.calendar.updateSize();
                    state.calendar.refetchEvents();
                    return;
                }

                state.calendar = new FullCalendar.Calendar(el, {
                    initialView: window.innerWidth < 768 ? 'listDay' : 'timeGridDay',
                    headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
                    slotMinTime: '07:00:00',
                    slotMaxTime: '18:00:00',
                    height: '100%',
                    allDaySlot: false,
                    events: async (info, success, failure) => {
                        const levelIds = state.programs.filter(p => p.name === state.level).map(p => p.id);
                        const { data } = await supabase.from('classes').select('*, rooms(name)').in('program_id', levelIds);
                        success((data || []).map(c => ({
                            id: c.id,
                            title: `${c.subject} @ ${c.rooms?.name}`,
                            start: c.start_time,
                            end: c.end_time
                        })));
                    }
                });
                state.calendar.render();
            },

            async loadDirectory() {
                const { data } = await supabase.from('profiles').select('*').order('full_name');
                state.profiles = data || [];
                this.renderDirectory(state.profiles);
            },

            renderDirectory(list) {
                const grid = document.getElementById('directory-grid');
                grid.innerHTML = list.map(p => `
                    <div class="cyber-glass p-5 rounded-[2rem] flex items-center gap-4 hover:border-cyan-500/40 transition-all cursor-default">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-cyan-500/10 to-blue-500/10 border border-white/5 flex items-center justify-center font-black text-xl text-cyan-400 shadow-inner">
                            ${p.full_name[0]}
                        </div>
                        <div class="min-w-0">
                            <h5 class="text-sm font-bold text-white truncate">${p.full_name}</h5>
                            <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mt-0.5">${p.role || 'Staff'}</p>
                            <div class="flex items-center gap-1.5 mt-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                <span class="text-[8px] text-emerald-500 font-bold uppercase tracking-tighter">On Campus</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            searchDirectory(q) {
                const filtered = state.profiles.filter(p => p.full_name.toLowerCase().includes(q.toLowerCase()) || p.role?.toLowerCase().includes(q.toLowerCase()));
                this.renderDirectory(filtered);
            },

            async createClass(e) {
                e.preventDefault();
                const payload = {
                    subject: document.getElementById('f-subject').value,
                    program_id: document.getElementById('f-program').value,
                    room_id: document.getElementById('f-room').value,
                    teacher_id: state.user.id,
                    start_time: `${document.getElementById('f-date').value}T${document.getElementById('f-start').value}:00Z`,
                    end_time: `${document.getElementById('f-date').value}T${document.getElementById('f-end').value}:00Z`
                };

                const { error } = await supabase.from('classes').insert([payload]);
                if (!error) {
                    ui.closeModals();
                    if (state.calendar) state.calendar.refetchEvents();
                    e.target.reset();
                }
            },

            async loadUserSessions() {
                ui.openModal('modal-manage');
                const { data } = await supabase.from('classes').select('*, rooms(name)').eq('teacher_id', state.user.id);
                const list = document.getElementById('manage-list');
                list.innerHTML = (data || []).map(c => `
                    <div class="cyber-glass p-4 rounded-2xl flex items-center justify-between gap-4 border-white/5">
                        <div class="min-w-0">
                            <h6 class="text-sm font-bold text-white truncate">${c.subject}</h6>
                            <p class="text-[9px] text-slate-500 font-bold">${c.rooms?.name} | ${new Date(c.start_time).toLocaleDateString()}</p>
                        </div>
                        <button onclick="app.deleteSession('${c.id}')" class="w-10 h-10 bg-red-500/10 text-red-500 rounded-xl hover:bg-red-500 hover:text-white transition-all">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                `).join('') || `<p class="text-center py-8 text-slate-600 text-xs">No active posts found.</p>`;
            },

            async deleteSession(id) {
                if (!confirm("Remove this schedule?")) return;
                await supabase.from('classes').delete().eq('id', id);
                this.loadUserSessions();
                if (state.calendar) state.calendar.refetchEvents();
            },

            async handleAIChat(e) {
                e.preventDefault();
                const input = document.getElementById('ai-input');
                const box = document.getElementById('ai-messages');
                const query = input.value.trim();
                if (!query) return;

                input.value = "";
                box.innerHTML += `<div class="bg-cyan-600 p-4 rounded-3xl rounded-br-none text-xs text-white self-end max-w-[85%] shadow-lg shadow-cyan-900/20">${query}</div>`;
                box.scrollTop = box.scrollHeight;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: query }] }],
                            systemInstruction: { parts: [{ text: "You are the STEC Smart Kiosk AI. You help users find rooms and staff. Be professional and brief." }] }
                        })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "I'm having trouble processing that right now.";
                    box.innerHTML += `<div class="bg-white/5 p-4 rounded-3xl rounded-bl-none text-xs text-slate-300 self-start max-w-[85%] border border-white/5">${text}</div>`;
                } catch {
                    box.innerHTML += `<div class="bg-red-500/10 p-3 rounded-2xl text-[10px] text-red-400 self-center">Connection to STEC-Core lost.</div>`;
                }
                box.scrollTop = box.scrollHeight;
            }
        };

        window.onload = () => app.init();
    </script>
</body>
    </html>
