<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STEC Smart Kiosk</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Outfit:wght@300;400;600&display=swap');
        
        :root {
            --brand-primary: #ec4899;
            --brand-secondary: #8b5cf6;
            --glass-bg: rgba(15, 23, 42, 0.9);
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background: #020617;
            color: #f8fafc;
            height: 100vh;
            overflow: hidden;
            display: flex;
            margin: 0;
        }

        .glass { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .glass-card { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255,255,255,0.05); }
        
        .sidebar-link.active { color: white; background: rgba(236, 72, 153, 0.15); border-left: 4px solid var(--brand-primary); }
        
        @media (max-width: 1023px) {
            body { flex-direction: column; }
            .sidebar-link.active { border-left: 0; border-top: 4px solid var(--brand-primary); }
        }

        .fc-event { cursor: pointer; border: none !important; background: linear-gradient(to right, #ec4899, #8b5cf6) !important; font-size: 0.75rem; }
        .level-btn.active { background: var(--brand-primary); color: white; }
        
        .tab-content { display: none; height: 100%; width: 100%; position: absolute; inset: 0; }
        .tab-content.active { display: flex; flex-direction: column; }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
    </style>
</head>
<body>

    <!-- SIDEBAR NAV -->
    <nav class="order-last lg:order-first w-full lg:w-72 flex lg:flex-col glass border-t lg:border-t-0 lg:border-r border-white/10 z-50 shrink-0">
        <div class="hidden lg:block p-8">
            <h1 class="text-2xl font-black tracking-tighter bg-gradient-to-r from-pink-500 to-violet-500 bg-clip-text text-transparent">STEC KIOSK</h1>
        </div>

        <div class="flex flex-row lg:flex-col flex-grow justify-around lg:justify-start px-2 py-2 lg:space-y-1">
            <button onclick="switchTab('map')" id="nav-map" class="sidebar-link active flex-1 lg:flex-none p-3 lg:p-4 rounded-xl flex flex-col lg:flex-row items-center gap-2 text-slate-400 transition-all">
                <i class="fa-solid fa-map-marked-alt lg:text-xl"></i>
                <span class="text-[10px] lg:text-sm font-bold">Map</span>
            </button>
            <button onclick="switchTab('calendar')" id="nav-calendar" class="sidebar-link flex-1 lg:flex-none p-3 lg:p-4 rounded-xl flex flex-col lg:flex-row items-center gap-2 text-slate-400 transition-all">
                <i class="fa-solid fa-calendar-alt lg:text-xl"></i>
                <span class="text-[10px] lg:text-sm font-bold">Schedules</span>
            </button>
            <button onclick="switchTab('directory')" id="nav-directory" class="sidebar-link flex-1 lg:flex-none p-3 lg:p-4 rounded-xl flex flex-col lg:flex-row items-center gap-2 text-slate-400 transition-all">
                <i class="fa-solid fa-users lg:text-xl"></i>
                <span class="text-[10px] lg:text-sm font-bold">Directory</span>
            </button>
            <button onclick="openAIDrawer()" class="lg:hidden flex-1 p-3 rounded-xl flex flex-col items-center gap-2 text-indigo-400">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <span class="text-[10px] font-bold">AI</span>
            </button>
        </div>

        <!-- ADMIN CONTROLS DESKTOP -->
        <div class="hidden lg:block p-4 mt-auto space-y-4">
            <div id="admin-tools" class="hidden space-y-2">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest px-2">Management</p>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="openModal('modal-class')" class="p-3 bg-emerald-600/20 border border-emerald-500/30 rounded-xl text-emerald-400 text-[10px] font-bold uppercase hover:bg-emerald-600/30 transition-all">
                        <i class="fa-solid fa-plus-circle mb-1 block text-base"></i>Add
                    </button>
                    <button onclick="openDeleteModal()" class="p-3 bg-red-600/20 border border-red-500/30 rounded-xl text-red-400 text-[10px] font-bold uppercase hover:bg-red-600/30 transition-all">
                        <i class="fa-solid fa-trash mb-1 block text-base"></i>Manage
                    </button>
                </div>
            </div>

            <div class="glass-card p-4 rounded-2xl">
                <p class="text-[10px] font-black text-pink-500 uppercase mb-3 tracking-widest">Global Filter</p>
                <div class="flex p-1 bg-slate-900 rounded-lg">
                    <button onclick="setSchoolLevel('Junior High')" id="lvl-jhs" class="level-btn active flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all">JHS</button>
                    <button onclick="setSchoolLevel('Senior High')" id="lvl-shs" class="level-btn flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all">SHS</button>
                </div>
            </div>

            <button onclick="openAIDrawer()" class="w-full p-4 bg-gradient-to-br from-indigo-600 to-violet-700 rounded-2xl flex items-center justify-center gap-3 font-bold hover:scale-[1.02] transition shadow-xl">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <span>Ask Assistant</span>
            </button>
        </div>
    </nav>

    <!-- CONTENT AREA -->
    <main class="flex-grow flex flex-col relative overflow-hidden h-full">
        <header class="h-16 lg:h-20 flex items-center justify-between px-6 lg:px-10 border-b border-white/5 bg-slate-950/40 backdrop-blur-md shrink-0">
            <div>
                <h2 id="view-title" class="text-lg lg:text-2xl font-bold text-white">Campus Navigator</h2>
                <span id="current-time" class="text-[10px] lg:text-xs text-slate-500 font-bold uppercase tracking-widest">12:00 PM</span>
            </div>

            <div class="flex items-center gap-4">
                <button id="login-btn" onclick="openModal('modal-login')" class="px-4 py-2 glass-card rounded-xl text-xs font-bold hover:text-pink-400 transition">
                    <i class="fa-solid fa-lock mr-2"></i>Admin Access
                </button>
            </div>
        </header>

        <div class="flex-grow relative">
            <!-- TAB: MAP -->
            <div id="tab-map" class="tab-content active p-6">
                <div class="glass-card h-full rounded-3xl border-dashed border-2 border-white/10 flex flex-col items-center justify-center">
                    <i class="fa-solid fa-map-location-dot text-6xl text-slate-800 mb-4"></i>
                    <p class="text-slate-500 font-medium">Map system initializing...</p>
                </div>
            </div>

            <!-- TAB: CALENDAR -->
            <div id="tab-calendar" class="tab-content p-4">
                <div class="glass-card h-full rounded-2xl p-4 overflow-hidden">
                    <div id="calendar" class="h-full"></div>
                </div>
            </div>

            <!-- TAB: DIRECTORY -->
            <div id="tab-directory" class="tab-content p-6 overflow-y-auto">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <h3 class="text-xl font-bold">Faculty Directory</h3>
                    <input type="text" id="dir-search" oninput="filterDirectory()" placeholder="Search staff..." class="w-full md:w-64 bg-slate-800 border-none rounded-xl px-4 py-2 text-sm text-white outline-none ring-1 ring-white/10">
                </div>
                <div id="directory-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 pb-20"></div>
            </div>
        </div>
    </main>

    <!-- MODAL: LOGIN -->
    <div id="modal-login" class="modal-overlay">
        <div class="w-full max-w-sm glass p-8 rounded-[32px] relative m-4">
            <button onclick="closeModals()" class="absolute top-6 right-6 text-slate-500 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-center mb-6">Staff Login</h3>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="text" id="log-user" placeholder="Full Name" required class="w-full bg-slate-800 p-4 rounded-xl text-white outline-none ring-1 ring-white/10 focus:ring-pink-500">
                <input type="password" id="log-pass" placeholder="Passkey" required class="w-full bg-slate-800 p-4 rounded-xl text-white outline-none ring-1 ring-white/10 focus:ring-pink-500">
                <button type="submit" class="w-full py-4 bg-pink-600 rounded-xl font-bold shadow-xl hover:bg-pink-700 transition">Unlock Admin Tools</button>
            </form>
        </div>
    </div>

    <!-- MODAL: ADD CLASS -->
    <div id="modal-class" class="modal-overlay">
        <div class="w-full max-w-lg glass p-8 rounded-[32px] relative m-4 overflow-y-auto max-h-[90vh]">
            <button onclick="closeModals()" class="absolute top-6 right-6 text-slate-500 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6">Post New Schedule</h3>
            <form onsubmit="handleClassSubmit(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Subject</label>
                    <input type="text" id="f-subject" required class="w-full bg-slate-800 p-3 rounded-xl text-white outline-none ring-1 ring-white/10">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Section</label>
                    <select id="f-program" required class="w-full bg-slate-800 p-3 rounded-xl text-white outline-none ring-1 ring-white/10"></select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Room</label>
                    <select id="f-room" required class="w-full bg-slate-800 p-3 rounded-xl text-white outline-none ring-1 ring-white/10"></select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Date</label>
                    <input type="date" id="f-date" required class="w-full bg-slate-800 p-3 rounded-xl text-white outline-none ring-1 ring-white/10">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Start Time</label>
                    <input type="time" id="f-start" required class="w-full bg-slate-800 p-3 rounded-xl text-white outline-none ring-1 ring-white/10">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">End Time</label>
                    <input type="time" id="f-end" required class="w-full bg-slate-800 p-3 rounded-xl text-white outline-none ring-1 ring-white/10">
                </div>
                <button type="submit" class="md:col-span-2 mt-4 py-4 bg-emerald-600 rounded-xl font-bold hover:bg-emerald-700 transition">Publish Schedule</button>
            </form>
        </div>
    </div>

    <!-- MODAL: DELETE -->
    <div id="modal-delete" class="modal-overlay">
        <div class="w-full max-w-md glass p-8 rounded-[32px] relative m-4 flex flex-col max-h-[80vh]">
            <button onclick="closeModals()" class="absolute top-6 right-6 text-slate-500 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-2">My Sessions</h3>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-6">Manage your posts</p>
            <div id="delete-list" class="space-y-3 overflow-y-auto pr-2"></div>
        </div>
    </div>

    <!-- MODAL: AI DRAWER -->
    <div id="modal-ai" class="modal-overlay" style="justify-content: flex-end;">
        <div class="w-full max-w-md glass h-full flex flex-col shadow-2xl">
            <div class="p-6 border-b border-white/5 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center"><i class="fa-solid fa-robot text-white"></i></div>
                    <div>
                        <h3 class="font-bold text-sm">STEC AI Assistant</h3>
                        <p class="text-[10px] text-emerald-500">System Connected</p>
                    </div>
                </div>
                <button onclick="closeModals()" class="text-slate-500 p-2"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="chat-box" class="flex-grow overflow-y-auto p-6 flex flex-col gap-4 bg-slate-950/20">
                <div class="bg-slate-800 p-4 rounded-2xl rounded-bl-none text-sm text-slate-300 self-start max-w-[85%]">
                    Hi! I can help you find rooms or check schedules. What's on your mind?
                </div>
            </div>
            <form onsubmit="handleAIChat(event)" class="p-4 bg-slate-900 border-t border-white/5 flex gap-2">
                <input type="text" id="ai-input" placeholder="Type your question..." class="flex-grow bg-slate-800 rounded-xl px-4 py-3 text-sm text-white outline-none">
                <button type="submit" class="w-12 h-12 bg-indigo-600 rounded-xl text-white flex items-center justify-center"><i class="fa-solid fa-paper-plane"></i></button>
            </form>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const CONFIG = {
            URL: "https://nwwkgmlnnlsmbjrvcnaj.supabase.co",
            KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53d2tnbWxubmxzbWJqcnZjbmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTYxMDcsImV4cCI6MjA4MTM3MjEwN30.Stz0PC0XAxlAkmHpWxY9reIeVzbXaDKuiSUOrJ4HB7Y"
        };

        const supabase = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
        
        let state = {
            user: null,
            calendar: null,
            level: 'Junior High',
            allProfiles: [],
            allPrograms: []
        };

        // UI HELPERS
        function openModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.classList.add('open');
        }

        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open'));
        }

        function switchTab(tabId) {
            // UI Update
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.getElementById(`nav-${tabId}`).classList.add('active');
            
            const labels = { map: 'Campus Navigator', calendar: 'Class Schedules', directory: 'Personnel Directory' };
            document.getElementById('view-title').textContent = labels[tabId];
            
            if(tabId === 'calendar') renderCalendar();
            if(tabId === 'directory') loadDirectory();
        }

        // FEATURE: CALENDAR
        function renderCalendar() {
            const el = document.getElementById('calendar');
            const isMobile = window.innerWidth < 1024;
            
            if (state.calendar) {
                state.calendar.updateSize();
                state.calendar.changeView(isMobile ? 'listDay' : 'timeGridDay');
                state.calendar.refetchEvents();
                return;
            }

            state.calendar = new FullCalendar.Calendar(el, {
                initialView: isMobile ? 'listDay' : 'timeGridDay',
                headerToolbar: { left: 'prev,next', center: 'title', right: '' },
                height: '100%',
                allDaySlot: false,
                slotMinTime: '07:00:00',
                slotMaxTime: '18:00:00',
                events: async (info, success, failure) => {
                    const progIds = state.allPrograms.filter(p => p.name === state.level).map(p => p.id);
                    const { data, error } = await supabase.from('classes')
                        .select('*, rooms(name)')
                        .in('program_id', progIds);
                    
                    if(error) return failure(error);
                    success((data || []).map(c => ({
                        id: c.id,
                        title: `${c.subject} (${c.rooms?.name})`,
                        start: c.start_time,
                        end: c.end_time
                    })));
                }
            });
            
            // Timeout to ensure container is fully painted
            setTimeout(() => state.calendar.render(), 50);
        }

        // FEATURE: DIRECTORY
        async function loadDirectory() {
            const { data } = await supabase.from('profiles').select('*').order('full_name');
            state.allProfiles = data || [];
            displayDirectory(state.allProfiles);
        }

        function displayDirectory(list) {
            document.getElementById('directory-grid').innerHTML = list.map(p => `
                <div class="glass-card p-4 rounded-2xl flex items-center gap-4 hover:border-pink-500/40 transition-all">
                    <div class="w-10 h-10 rounded-lg bg-pink-500/10 flex items-center justify-center font-bold text-pink-500">${p.full_name[0]}</div>
                    <div class="min-w-0">
                        <div class="text-sm font-bold truncate">${p.full_name}</div>
                        <div class="text-[9px] text-slate-500 uppercase tracking-widest font-black">${p.role || 'Staff'}</div>
                    </div>
                </div>
            `).join('');
        }

        function filterDirectory() {
            const q = document.getElementById('dir-search').value.toLowerCase();
            displayDirectory(state.allProfiles.filter(p => p.full_name.toLowerCase().includes(q)));
        }

        // FEATURE: ADMIN
        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('log-user').value;
            const p = document.getElementById('log-pass').value;
            
            const { data } = await supabase.from('profiles').select('*').eq('full_name', u).eq('passkey', p).single();
            if(data) {
                state.user = data;
                closeModals();
                document.getElementById('admin-tools').classList.remove('hidden');
                document.getElementById('login-btn').innerHTML = `<i class="fa-solid fa-user-circle mr-2"></i> ${data.full_name.split(' ')[0]}`;
                document.getElementById('login-btn').classList.add('text-emerald-400');
            } else {
                alert("Unauthorized user.");
            }
        }

        async function handleClassSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('f-date').value;
            const start = `${date}T${document.getElementById('f-start').value}:00Z`;
            const end = `${date}T${document.getElementById('f-end').value}:00Z`;

            const { error } = await supabase.from('classes').insert([{
                subject: document.getElementById('f-subject').value,
                program_id: document.getElementById('f-program').value,
                room_id: document.getElementById('f-room').value,
                teacher_id: state.user.id,
                start_time: start,
                end_time: end
            }]);

            if(!error) {
                closeModals();
                if(state.calendar) state.calendar.refetchEvents();
                e.target.reset();
            }
        }

        async function openDeleteModal() {
            if(!state.user) return;
            openModal('modal-delete');
            const { data } = await supabase.from('classes').select('*, rooms(name)').eq('teacher_id', state.user.id);
            document.getElementById('delete-list').innerHTML = (data || []).map(c => `
                <div class="glass-card p-4 rounded-xl flex justify-between items-center">
                    <div class="min-w-0 pr-4">
                        <div class="text-xs font-bold truncate">${c.subject}</div>
                        <div class="text-[9px] text-slate-500">Room ${c.rooms?.name}</div>
                    </div>
                    <button onclick="deleteClass('${c.id}')" class="w-8 h-8 text-red-500 hover:bg-red-500/10 rounded-lg"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        }

        async function deleteClass(id) {
            await supabase.from('classes').delete().eq('id', id);
            openDeleteModal();
            if(state.calendar) state.calendar.refetchEvents();
        }

        // FEATURE: AI
        async function handleAIChat(e) {
            e.preventDefault();
            const input = document.getElementById('ai-input');
            const box = document.getElementById('chat-box');
            if(!input.value.trim()) return;

            const query = input.value;
            input.value = "";
            box.innerHTML += `<div class="bg-indigo-600 p-4 rounded-2xl rounded-br-none text-sm text-white self-end max-w-[85%]">${query}</div>`;
            box.scrollTop = box.scrollHeight;

            const { data: sched } = await supabase.from('classes').select('*, profiles(full_name), rooms(name)');
            const context = (sched || []).map(s => `${s.subject} by ${s.profiles?.full_name} in ${s.rooms?.name}`).join(", ");

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: query }] }],
                        systemInstruction: { parts: [{ text: `You are the STEC AI. Active classes: ${context}. Answer briefly.` }] }
                    })
                });
                const data = await res.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
                box.innerHTML += `<div class="bg-slate-800 p-4 rounded-2xl rounded-bl-none text-sm text-slate-300 self-start max-w-[85%]">${aiText}</div>`;
            } catch {
                box.innerHTML += `<div class="bg-red-900/20 p-4 rounded-2xl text-xs text-red-400 self-center">Connection failed.</div>`;
            }
            box.scrollTop = box.scrollHeight;
        }

        function openAIDrawer() { openModal('modal-ai'); }

        function setSchoolLevel(l) {
            state.level = l;
            document.getElementById('lvl-jhs').classList.toggle('active', l === 'Junior High');
            document.getElementById('lvl-shs').classList.toggle('active', l === 'Senior High');
            if(state.calendar) state.calendar.refetchEvents();
        }

        // INIT
        window.onload = async () => {
            setInterval(() => {
                document.getElementById('current-time').textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            }, 1000);

            // Prefetch dropdown data
            const [progs, rms] = await Promise.all([
                supabase.from('programs').select('*'),
                supabase.from('rooms').select('*')
            ]);
            state.allPrograms = progs.data || [];
            
            document.getElementById('f-program').innerHTML = state.allPrograms.map(p => `<option value="${p.id}">${p.name}: ${p.grade_level}-${p.section}</option>`).join('');
            document.getElementById('f-room').innerHTML = (rms.data || []).map(r => `<option value="${r.id}">${r.name}</option>`).join('');
        };
    </script>
</body>
</html>
