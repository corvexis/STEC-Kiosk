<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEC Kiosk</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Kiosk Mode: Fullscreen feel, allow vertical scroll on small screens */
        html, body, #app { height: 100%; margin: 0; padding: 0; }
        #app { overflow-y: auto; }
        
        /* FullCalendar styling tweaks - Ensure visibility in dark mode */
        .fc-toolbar-title { 
            font-size: 1.5rem !important; 
            font-weight: 800; 
            color: #ec4899; /* Always visible pink */
        }
        /* Enforce dark style for calendar buttons */
        .fc-button, .fc-button:hover { 
            background-color: #4b5563; /* dark gray buttons */
            border-color: #374151;
            color: #d1d5db; /* light text */
        }
        .fc-event-title { white-space: normal; }
        /* Adjust calendar padding for mobile */
        #calendar { padding: 0.5rem; }
        @media (min-width: 768px) {
            #calendar { padding: 1rem; }
        }
        #map { height: 100%; width: 100%; border-radius: 0.5rem; }

        /* Off-Canvas Menu Styling */
        #menu-sidebar {
            transition: transform 0.3s ease-out;
            transform: translateX(100%);
            z-index: 60;
        }
        #menu-sidebar.open {
            transform: translateX(0);
        }
        .text-gemini {
            color: #1973E8; /* Google Blue */
        }
        /* Style for the attribution footer */
        .app-footer {
            background-color: #1f2937; /* Gray-800 */
        }
    </style>

    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <!-- FullCalendar CSS and JS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js'></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Leaflet JS for Map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    
    <!-- Firebase Imports for Auth (for Canvas environment sign-in) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase objects globally for use in the main script block
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel
        };
    </script>
</head>
<body>

    <!-- Off-Canvas Menu -->
    <div id="menu-sidebar" class="fixed top-0 right-0 w-64 h-full bg-gray-900 border-l border-gray-700 shadow-xl p-6 flex flex-col justify-start">
        <button id="close-menu" class="absolute top-4 right-4 text-gray-300 hover:text-pink-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <h3 class="text-xl font-bold mb-6 text-pink-400 mt-8">Admin Access</h3>
        
        <!-- Authentication Button -->
        <button id="auth-button" class="w-full text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 mb-4 bg-green-600 hover:bg-green-700">
            Sign In as Admin
        </button>
        <button id="add-new-schedule-button" class="hidden w-full bg-pink-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-pink-700 transition duration-300">
            + Add New Schedule
        </button>

        <p class="text-sm text-gray-400 mt-auto pt-4 border-t border-gray-700">
            Signed in as: <span id="current-signed-in-user" class="font-semibold text-pink-400 block truncate">Kiosk Viewer</span>
        </p>
    </div>

    <!-- Main App Container -->
    <div id="app" class="flex flex-col bg-gray-900 h-full transition-colors duration-300">

        <!-- HEADER (Pink and Grey) -->
        <header class="bg-gray-800 text-white shadow-xl p-4 flex justify-between items-center z-10 sticky top-0">
            <!-- Left Side: Hamburger Menu & Title -->
            <div class="flex items-center space-x-3">
                <button id="hamburger-menu" class="p-1 rounded hover:bg-gray-700 transition duration-150">
                    <svg class="w-6 h-6 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 class="text-xl md:text-3xl font-extrabold tracking-tight text-pink-400">
                    <span id="school-name">BCSTEC</span> Kiosk
                </h1>
            </div>

            <!-- Right Side: User Status -->
            <span id="user-status" class="text-xs md:text-sm font-semibold rounded-full px-2 py-1 md:px-3 md:py-1 bg-pink-700">
                Kiosk View Mode
            </span>
        </header>

        <!-- MAIN CONTENT AREA: Stacks vertically on mobile -->
        <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
            <!-- SIDEBAR/FILTERS -->
            <aside id="filter-sidebar" class="w-full md:w-1/4 md:max-w-xs bg-gray-800 p-4 md:overflow-y-auto border-r border-gray-700 shadow-md transition-colors duration-300">
                <h2 class="text-xl font-bold mb-4 text-pink-400">Filter Schedule</h2>

                <!-- Program Tabs (Junior/Senior) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Program:</label>
                    <div class="flex space-x-2" id="program-tabs">
                        <button data-program="Junior High" class="program-tab bg-pink-900 text-pink-100 font-semibold py-2 px-4 rounded-lg flex-1 shadow-sm hover:bg-pink-800 transition duration-150 text-sm">Junior High</button>
                        <button data-program="Senior High" class="program-tab bg-gray-700 text-gray-300 font-semibold py-2 px-4 rounded-lg flex-1 shadow-sm hover:bg-gray-600 transition duration-150 text-sm">Senior High</button>
                    </div>
                </div>

                <!-- Grade Level Filter (Dynamic) -->
                <div class="mb-4">
                    <label for="grade-filter" class="block text-sm font-medium text-gray-300 mb-2">Grade Level:</label>
                    <select id="grade-filter" class="w-full p-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-pink-500 focus:border-pink-500 shadow-sm text-sm"></select>
                </div>

                <!-- Section Filter (Dynamic) -->
                <div class="mb-4">
                    <label for="section-filter" class="block text-sm font-medium text-gray-300 mb-2">Section:</label>
                    <select id="section-filter" class="w-full p-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-pink-500 focus:border-pink-500 shadow-sm text-sm"></select>
                </div>

                <!-- See Schedule Button -->
                <button id="see-schedule-button"
                        class="w-full bg-pink-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-pink-700 transition duration-300 mt-4 text-sm">
                    See Schedule
                </button>

                <!-- Ask Assistant Button -->
                <button id="ask-assistant-button"
                        class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 mt-4 text-sm">
                    Ask STEC-Buddy (AI)
                </button>
                
                <!-- Action Button for Admins/Teachers - Now accessible via off-canvas menu -->
                <button id="add-schedule-button"
                        class="hidden w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-600 transition duration-300 mt-4 text-sm">
                    + Add New Class
                </button>

                <!-- Map View Toggle -->
                <div class="mt-6 pt-4 border-t border-gray-700">
                    <h3 class="text-lg font-bold text-pink-400 mb-2">Campus Map</h3>
                    <button id="map-toggle-button"
                            class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-gray-700 transition duration-300 text-sm">
                        View Floor Plan
                    </button>
                </div>

            </aside>

            <!-- MAIN VIEW (Calendar or Map) -->
            <main id="main-view-container" class="flex-grow flex flex-col bg-gray-800 overflow-hidden transition-colors duration-300">
                <!-- Calendar View -->
                <div id="calendar-view" class="flex-grow w-full min-h-[500px] md:min-h-0">
                    <div id='calendar' class="h-full w-full"></div>
                </div>
                <!-- Map View (Hidden by default) -->
                <div id="map-view" class="h-full w-full hidden p-4">
                    <h2 class="text-xl md:text-2xl font-bold mb-4 text-pink-400">Floor Plan Hotspots</h2>
                    <div id="map" class="h-[80vh] md:h-[90%] w-full"></div>
                </div>
            </main>
        </div>

        <!-- FOOTER / ATTRIBUTIONS -->
        <footer class="app-footer text-center p-3 text-gray-400 text-xs md:text-sm border-t border-gray-700">
            <p class="mb-1">Made by <span class="font-semibold text-white">Hero Ginete</span></p>
            <div class="flex items-center justify-center font-bold">
                <p class="mr-2">STEC-Buddy Powered by:</p>
                <svg viewBox="0 0 24 24" class="w-5 h-5 mr-1" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Google Gemini Logo Path (Simplified, using Google colors) -->
                    <path fill="#4285F4" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
                    <path fill="#FBBC05" d="M12 6.5l2.5 4.5h-5L12 6.5z"/>
                    <path fill="#EA4335" d="M12 17.5l-2.5-4.5h5L12 17.5z"/>
                    <path fill="#34A853" d="M15 12h-6v-1h6v1z"/>
                </svg>
                <span class="text-gemini">Google Gemini</span>
            </div>
        </footer>
    </div>

    <!-- MODAL: Class Detail (Edit form now conditionally visible) -->
    <div id="detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-lg transition-colors duration-300">
            <h3 id="detail-title" class="text-2xl font-bold mb-4 text-pink-400">Class Details</h3>
            <div id="detail-content" class="space-y-3 text-gray-300">
                <p><span class="font-medium">Subject:</span> <span id="detail-subject"></span></p>
                <p><span class="font-medium">Teacher:</span> <span id="detail-teacher"></span></p>
                <p><span class="font-medium">Room:</span> <span id="detail-room"></span></p>
                <p><span class="font-medium">Time:</span> <span id="detail-time"></span></p>
                <p><span class="font-medium">Program:</span> <span id="detail-program"></span></p>
            </div>
            <!-- Edit Form is conditionally shown for Admin/Teacher -->
            <form id="edit-form" class="mt-6 space-y-4 hidden">
                <h4 class="text-xl font-semibold border-t pt-4 text-pink-400 border-gray-700">Edit Class (Admin/Teacher)</h4>
                <input type="hidden" id="edit-id">

                <label class="block text-sm font-medium text-gray-300">New Subject:</label>
                <input type="text" id="edit-subject" required class="w-full p-2 border rounded border-gray-600 bg-gray-700 text-white focus:ring-pink-500 focus:border-pink-500">

                <label class="block text-sm font-medium text-gray-300">New Start Time (YYYY-MM-DD HH:MM):</label>
                <input type="datetime-local" id="edit-start" required class="w-full p-2 border rounded border-gray-600 bg-gray-700 text-white focus:ring-pink-500 focus:border-pink-500">
                
                <label class="block text-sm font-medium text-gray-300">New End Time (YYYY-MM-DD HH:MM):</label>
                <input type="datetime-local" id="edit-end" required class="w-full p-2 border rounded border-gray-600 bg-gray-700 text-white focus:ring-pink-500 focus:border-pink-500">

                <label class="block text-sm font-medium text-gray-300">New Room:</label>
                <select id="edit-room" class="w-full p-2 border rounded border-gray-600 bg-gray-700 text-white focus:ring-pink-500 focus:border-pink-500"></select>
                
                <label class="block text-sm font-medium text-gray-300">New Teacher:</label>
                <select id="edit-teacher" class="w-full p-2 border rounded border-gray-600 bg-gray-700 text-white focus:ring-pink-500 focus:border-pink-500"></select>

                <div class="flex flex-col space-y-2 md:space-y-0 md:flex-row md:space-x-4">
                    <button type="submit" class="flex-1 bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700 transition duration-300">Save Changes</button>
                    <button id="delete-class-button" type="button" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 transition duration-300">Delete Class</button>
                </div>
            </form>

            <button id="close-detail-modal" class="mt-6 w-full bg-gray-700 text-gray-300 py-2 rounded-lg hover:bg-gray-600 transition duration-300">Close</button>
        </div>
    </div>
    
    <!-- MODAL: Assistant Chat (STEC-Buddy) -->
    <div id="assistant-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-lg transition-colors duration-300 flex flex-col h-5/6">
            <h3 class="text-2xl font-bold mb-4 text-blue-400 border-b border-gray-700 pb-2">STEC-Buddy: Your Kiosk Assistant</h3>
            
            <!-- Chat History Container -->
            <div id="chat-history" class="flex-grow overflow-y-auto space-y-4 mb-4 pr-2">
                <!-- Initial Welcome Message will be rendered here -->
            </div>
            
            <!-- Input and Send Button -->
            <form id="chat-form" class="flex space-x-3">
                <input type="text" id="chat-input" placeholder="Ask a question..." required
                       class="flex-grow p-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                <button type="submit" id="chat-send-button"
                        class="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex-shrink-0 disabled:bg-gray-500">
                    Send
                </button>
            </form>

            <button id="close-assistant-modal" class="mt-6 w-full bg-gray-700 text-gray-300 py-2 rounded-lg hover:bg-gray-600 transition duration-300">Close</button>
        </div>
    </div>

    <!-- MODAL: Supabase Login (New) -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm transition-colors duration-300">
            <h3 class="text-2xl font-bold mb-4 text-green-400">Teacher/Admin Sign In</h3>
            <form id="login-form" class="space-y-4">
                <p id="login-error-message" class="text-red-400 text-sm hidden"></p>

                <div>
                    <label for="login-name" class="block text-sm font-medium text-gray-300 mb-1">Full Name (from Profiles Table)</label>
                    <input type="text" id="login-name" required 
                           class="w-full p-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm">
                </div>

                <div>
                    <label for="login-passkey" class="block text-sm font-medium text-gray-300 mb-1">Passkey</label>
                    <input type="password" id="login-passkey" required 
                           class="w-full p-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm">
                </div>
                
                <button type="submit" id="login-button" 
                        class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300 disabled:bg-gray-500">
                    Sign In
                </button>
            </form>

            <button id="close-login-modal" class="mt-4 w-full bg-gray-700 text-gray-300 py-2 rounded-lg hover:bg-gray-600 transition duration-300">Cancel</button>
        </div>
    </div>


    <script type="module">
        // ====================================================================
        // FIREBASE/CANVAS ENVIRONMENT CONFIG
        // ====================================================================
        const firebase = window.firebase;
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let fbApp, auth, db; // Firebase instances

        // ====================================================================
        // SUPABASE CONFIGURATION
        // ====================================================================
        const SUPABASE_URL = 'https://nwwkgmlnnlsmbjrvcnaj.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53d2tnbWxubmxzbWJqcnZjbmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTYxMDcsImV4cCI6MjA4MTM3MjEwN30.Stz0PC0XAxlAkmHpWxY9reIeVzbXaDKuiSUOrJ4HB7Y'; 

        if (SUPABASE_URL.startsWith('YOUR')) {
            console.error("CRITICAL ERROR: Please update SUPABASE_URL and SUPABASE_ANON_KEY in the script.");
        }

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ====================================================================
        // GLOBAL STATE
        // ====================================================================
        let calendar = null;
        let map = null;
        let allClasses = [];
        let allRooms = [];
        let allProfiles = [];
        let allPrograms = []; 
        let currentRole = 'student'; // Role determined by Supabase login
        let currentUsername = 'Kiosk Viewer';
        let currentProgram = 'Junior High';
        let currentGrade = null;
        let currentSection = null;
        const GEMINI_API_KEY = "AIzaSyALJamFpolfBxaOMWidlkZRK2dk4Gx3mH8"; 
        
        let chatHistory = [{
            role: "model",
            parts: [{ text: "Hello! I am **STEC-Buddy**, your helpful Kiosk Assistant. I can answer questions about the school, schedules, and rooms. How can I help you today?" }]
        }];

        // ====================================================================
        // TIME ZONE HELPER
        // ====================================================================
        
        /**
         * Gets the current time formatted for the Philippine time zone (Asia/Manila, UTC+8).
         */
        function getPhCurrentTime() {
            const options = {
                timeZone: 'Asia/Manila',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            const formatter = new Intl.DateTimeFormat('en-US', options);
            const parts = formatter.formatToParts(new Date());

            const year = parts.find(p => p.type === 'year').value;
            const month = parts.find(p => p.type === 'month').value;
            const day = parts.find(p => p.type === 'day').value;
            const hour = parts.find(p => p.type === 'hour').value;
            const minute = parts.find(p => p.type === 'minute').value;
            const second = parts.find(p => p.type === 'second').value;

            // Return a structured string for the LLM
            return `${year}-${month}-${day} ${hour}:${minute}:${second} (PH Time, UTC+8/Asia/Manila)`;
        }


        // ====================================================================
        // DATA FETCHING AND REAL-TIME SUBSCRIPTIONS
        // ====================================================================

        async function fetchStaticData() {
            try {
                // Fetch Rooms
                const { data: rooms, error: roomError } = await supabase.from('rooms').select('*');
                if (roomError) throw roomError;
                allRooms = rooms;
                initializeMap(); // Initialize map as soon as rooms are available

                // Fetch Profiles (for login validation and teacher selection in admin mode)
                const { data: profiles, error: profileError } = await supabase.from('profiles').select('id, full_name, role');
                if (profileError) throw profileError;
                allProfiles = profiles;
                console.log('Fetched Profiles:', allProfiles.length);
                
                // Fetch the master list of programs for filters
                const { data: programs, error: programError } = await supabase.from('programs').select('*');
                if (programError) throw programError;
                allPrograms = programs;
                
                renderFilters();
                renderTeacherSelects(); // Populate teacher dropdowns for admin mode

            } catch (error) {
                console.error('Error fetching static data:', error.message);
            }
        }

        function setupRealtimeListener() {
            supabase
                .channel('classes_changes')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'classes' },
                    (payload) => {
                        console.log('Realtime change received:', payload);
                        fetchAndRenderClasses(); 
                    }
                )
                .subscribe();

            fetchAndRenderClasses();
        }

        async function fetchAndRenderClasses() {
            try {
                const { data, error } = await supabase
                    .from('classes')
                    .select(`
                        id, subject, start_time, end_time, room_id, teacher_id,
                        programs(name, grade_level, section),
                        rooms(id, name, floor, map_coords),
                        teacher:profiles(id, full_name)
                    `);

                if (error) throw error;
                allClasses = data;
                
                if (!calendar) {
                    renderCalendar();
                } else {
                    renderCalendar(); // Re-render calendar to update events
                }

            } catch (error) {
                console.error('Error fetching classes:', error.message);
                if (error.code === 'PGRST116') {
                    allClasses = [];
                    if (!calendar) renderCalendar();
                }
            }
        }

        // ====================================================================
        // UI RENDERING & ADMIN TOOLS
        // ====================================================================

        /**
         * Updates all UI elements based on the current user role.
         */
        function updateUserUI() {
            // 1. Update Header Status
            const statusEl = document.getElementById('user-status');
            const authButton = document.getElementById('auth-button');
            const currentSignedUserEl = document.getElementById('current-signed-in-user');
            
            currentSignedUserEl.textContent = currentUsername;

            if (currentRole === 'teacher' || currentRole === 'admin') {
                statusEl.textContent = `${currentRole.toUpperCase()} MODE`;
                statusEl.classList.remove('bg-pink-700', 'bg-gray-500');
                statusEl.classList.add('bg-green-700');

                authButton.textContent = 'Sign Out';
                authButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                authButton.classList.add('bg-red-600', 'hover:bg-red-700');
                
                // 2. Show Admin Controls
                document.getElementById('add-schedule-button').classList.remove('hidden');
                document.getElementById('add-new-schedule-button').classList.remove('hidden');
            } else {
                currentRole = 'student'; // Default fallback
                statusEl.textContent = 'Kiosk View Mode';
                statusEl.classList.remove('bg-green-700');
                statusEl.classList.add('bg-pink-700');
                
                authButton.textContent = 'Sign In as Admin';
                authButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                authButton.classList.add('bg-green-600', 'hover:bg-green-700');

                // 3. Hide Admin Controls
                document.getElementById('add-schedule-button').classList.add('hidden');
                document.getElementById('add-new-schedule-button').classList.add('hidden');
            }
            // Close menu after status update
            document.getElementById('menu-sidebar').classList.remove('open');
        }

        function renderTeacherSelects() {
            const teacherSelectEl = document.getElementById('edit-teacher');
            if (!teacherSelectEl) return;
            
            // Filter profiles to include only Teachers and Admins for assignment
            const teachers = allProfiles.filter(p => p.role === 'teacher' || p.role === 'admin');
            teacherSelectEl.innerHTML = '<option value="">Select Teacher</option>';
            teachers.forEach(teacher => {
                teacherSelectEl.innerHTML += `<option value="${teacher.id}">${teacher.full_name}</option>`;
            });
        }
        
        function renderFilters() {
            let currentProgramData = allPrograms.filter(p => p.name === currentProgram);

            // 1. Grade Filter
            const grades = [...new Set(currentProgramData.map(p => p.grade_level))].sort((a, b) => a - b);
            const gradeFilterEl = document.getElementById('grade-filter');
            gradeFilterEl.innerHTML = `<option value="">All Grades</option>`;
            grades.forEach(grade => {
                gradeFilterEl.innerHTML += `<option value="${grade}" ${grade == currentGrade ? 'selected' : ''}>Grade ${grade}</option>`;
            });

            // Filter program data by current grade if set, for populating section filters
            let sectionsSource = currentProgramData;
            if (currentGrade) {
                sectionsSource = currentProgramData.filter(p => p.grade_level == currentGrade);
            }

            // 2. Section Filter 
            const sectionFilterEl = document.getElementById('section-filter');
            const sections = [...new Set(sectionsSource.map(p => p.section))].sort();

            sectionFilterEl.innerHTML = `<option value="">All Sections</option>`;
            sections.forEach(section => {
                sectionFilterEl.innerHTML += `<option value="${section}" ${section === currentSection ? 'selected' : ''}>${section}</option>`;
            });
        }

        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');

            // 1. Apply Filters
            const filteredClasses = allClasses.filter(c => {
                const programMatch = c.programs.name === currentProgram;
                const gradeMatch = !currentGrade || c.programs.grade_level == currentGrade; 
                const sectionMatch = !currentSection || c.programs.section === currentSection;

                return programMatch && gradeMatch && sectionMatch;
            });

            // 2. Map data to FullCalendar events
            const events = filteredClasses.map(c => ({
                id: c.id,
                title: `${c.subject} - ${c.rooms.name}`,
                start: c.start_time,
                end: c.end_time,
                allDay: false,
                extendedProps: {
                    program: `${c.programs.name} G${c.programs.grade_level} Sec ${c.programs.section}`,
                    teacherName: c.teacher ? c.teacher.full_name : 'TBD',
                    teacherId: c.teacher ? c.teacher.id : null,
                    room: c.rooms.name,
                    roomId: c.room_id,
                    grade: c.programs.grade_level,
                    section: c.programs.section,
                },
                backgroundColor: c.programs.name === 'Junior High' ? '#ec4899' : '#6b7280', 
                borderColor: c.programs.name === 'Junior High' ? '#be185d' : '#374151' 
            }));

            // 3. Initialize/Update Calendar
            if (!calendar) {
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'timeGridWeek',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'timeGridDay,timeGridWeek,dayGridMonth'
                    },
                    events: events,
                    nowIndicator: true,
                    editable: currentRole === 'admin' || currentRole === 'teacher', 
                    selectable: false,
                    slotMinTime: '07:00:00',
                    slotMaxTime: '18:00:00',
                    eventClick: handleEventClick,
                    height: '100%', 
                    // Add eventDrop and eventResize handlers for admin role
                    eventDrop: handleEventChange,
                    eventResize: handleEventChange,
                });
                calendar.render();
            } else {
                // Update editable status based on currentRole
                calendar.setOption('editable', currentRole === 'admin' || currentRole === 'teacher');
                calendar.setOption('events', events);
                calendar.refetchEvents();
            }
        }

        function initializeMap() {
            if (map) return;
            // Use a placeholder image for the floor plan
            const floorPlanImageUrl = 'https://placehold.co/1000x800/222222/cccccc?text=SCHOOL+FLOOR+PLAN';
            const imageBounds = [[-800, 0], [0, 1000]]; 

            map = L.map('map', {
                crs: L.CRS.Simple,
                minZoom: -2,
                maxZoom: 2,
                center: [-400, 500], 
                zoom: 0,
                maxBounds: imageBounds,
                maxBoundsViscosity: 1.0
            });

            L.imageOverlay(floorPlanImageUrl, imageBounds).addTo(map);

            allRooms.forEach(room => {
                if (room.map_coords && room.map_coords.lat && room.map_coords.lng) {
                    const marker = L.marker([room.map_coords.lat, room.map_coords.lng]).addTo(map);

                    const now = new Date();
                    const currentClasses = allClasses.filter(c => {
                        const start = new Date(c.start_time);
                        const end = new Date(c.end_time);
                        const dayOfWeek = start.getDay(); 
                        return c.room_id === room.id && now >= start && now <= end && now.getDay() === dayOfWeek;
                    });

                    let popupContent = `<strong>${room.name} (${room.building} - Floor ${room.floor})</strong><br>`;

                    if (currentClasses.length > 0) {
                        popupContent += `<hr class="my-1"><strong>CURRENTLY:</strong><br>`;
                        currentClasses.forEach(c => {
                             const teacherName = c.teacher ? c.teacher.full_name : 'N/A';
                             popupContent += `<div>${c.subject} (G${c.programs.grade_level}) - ${teacherName}</div>`;
                        });
                    } else {
                        popupContent += `<hr class="my-1"><span class="text-green-600">Room is currently Free.</span>`;
                    }

                    marker.bindPopup(popupContent).openPopup();
                } else {
                    console.warn(`Room ${room.name} is missing map coordinates.`);
                }
            });
            map.fitBounds(imageBounds); 
        }
        
        // ====================================================================
        // GEMINI ASSISTANT FUNCTIONS (Kept from previous version)
        // ====================================================================

        function renderChat() {
            const chatHistoryEl = document.getElementById('chat-history');
            chatHistoryEl.innerHTML = '';
            
            chatHistory.forEach(message => {
                const isUser = message.role === 'user';
                const text = message.parts[0].text.startsWith('\nCurrent Time') ? message.parts[0].text.split('Original User Question:')[1].trim() : message.parts[0].text;
                
                const messageEl = document.createElement('div');
                messageEl.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
                
                const bubbleEl = document.createElement('div');
                bubbleEl.className = `p-3 rounded-xl max-w-[80%] shadow-lg text-sm`;

                if (isUser) {
                    bubbleEl.className += ' bg-pink-600 text-white rounded-br-none';
                } else {
                    bubbleEl.className += ' bg-blue-900 text-blue-100 rounded-bl-none';
                }

                let formattedText = text;
                formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
                
                bubbleEl.innerHTML = formattedText.replace(/\n/g, '<br>');

                messageEl.appendChild(bubbleEl);
                chatHistoryEl.appendChild(messageEl);
            });
            
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }

        async function handleSendMessage(e) {
            e.preventDefault();
            const inputEl = document.getElementById('chat-input');
            const sendButton = document.getElementById('chat-send-button');
            const chatHistoryEl = document.getElementById('chat-history');
            const userQuery = inputEl.value.trim();

            if (!userQuery) return;

            const MAX_HISTORY_LENGTH = 10; 
            if (chatHistory.length > MAX_HISTORY_LENGTH) {
                 chatHistory = [chatHistory[0], ...chatHistory.slice(-(MAX_HISTORY_LENGTH - 1))];
            }

            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });
            renderChat();
            inputEl.value = '';

            const nowPhTime = getPhCurrentTime();
            const scheduleContext = allClasses.map(c => ({
                grade: c.programs.grade_level,
                section: c.programs.section,
                subject: c.subject,
                startTime: c.start_time, 
                endTime: c.end_time,
                room: c.rooms.name,
                teacher: c.teacher.full_name
            }));
            const contextData = {
                currentTime: nowPhTime, 
                schedule: scheduleContext
            };


            sendButton.disabled = true;
            sendButton.textContent = 'Thinking...';
            chatHistoryEl.innerHTML += `
                <div id="loading-indicator" class="flex justify-start">
                    <div class="bg-blue-900 text-blue-100 p-3 rounded-xl rounded-bl-none max-w-[80%] shadow-lg text-sm italic opacity-70">
                        STEC-Buddy is typing...
                    </div>
                </div>`;
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;

            try {
                const systemInstruction = `You are **STEC-Buddy**, the BCSTEC Kiosk Assistant. You must use the provided current time and schedule data to answer specific questions about the next class or current class for a given grade and section (e.g., Grade 8 Gold). 
***IMPORTANT TIME ZONE RULE: All times provided (currentTime and schedule times) are in PH Time (Philippine Standard Time, UTC+8).*** If the data is insufficient or the question is general, answer politely using general knowledge and the Google Search tool. When calculating the next class, only consider classes that occur today or later and whose start time is strictly *after* the provided currentTime.`;
                
                const geminiResponse = await sendMessageToGemini(userQuery, systemInstruction, contextData, chatHistory);

                chatHistory.push({ role: "model", parts: [{ text: geminiResponse.text }] });
                
                renderChat();

            } catch (error) {
                console.error('Gemini API Error:', error);
                chatHistory.push({ 
                    role: "model", 
                    parts: [{ text: "Sorry, I encountered an error while processing your request. Please try again." }] 
                });
                renderChat();
            } finally {
                document.getElementById('loading-indicator')?.remove();
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
            }
        }

        async function sendMessageToGemini(userQuery, systemInstruction, contextData, history, maxRetries = 5) {
            const fullUserQuery = `
Current Time: ${contextData.currentTime}

Schedule Context (JSON, ${contextData.schedule.length} entries): ${JSON.stringify(contextData.schedule)}

Original User Question: ${userQuery}
`;

            const apiContents = JSON.parse(JSON.stringify(history)); 
            apiContents[apiContents.length - 1].parts = [{ text: fullUserQuery }];

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            const payload = {
                contents: apiContents,
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                }
            };
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            return { text };
                        } else {
                            throw new Error("API response successful but content was empty.");
                        }
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    } else {
                        const errorBody = await response.text();
                        throw new Error(`API call failed with status: ${response.status}. Response Body: ${errorBody}`);
                    }
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Failed to get response from Gemini API after multiple retries.");
        }


        // ====================================================================
        // EVENT HANDLERS
        // ====================================================================

        /**
         * Handles FullCalendar event click (show details modal and conditionally show edit form).
         */
        function handleEventClick(info) {
            const event = info.event;
            const classData = allClasses.find(c => c.id === event.id);

            if (!classData) return;

            // Populate Detail Modal
            document.getElementById('detail-subject').textContent = event.title.split(' - ')[0];
            document.getElementById('detail-teacher').textContent = event.extendedProps.teacherName;
            document.getElementById('detail-room').textContent = event.extendedProps.room;
            document.getElementById('detail-time').textContent = `${event.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${event.end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} (${event.start.toDateString()})`;
            document.getElementById('detail-program').textContent = event.extendedProps.program;

            const editForm = document.getElementById('edit-form');
            if (currentRole === 'teacher' || currentRole === 'admin') {
                // Populate Edit Form fields
                document.getElementById('edit-id').value = event.id;
                document.getElementById('edit-subject').value = classData.subject;
                
                // Format times for datetime-local input
                document.getElementById('edit-start').value = classData.start_time.substring(0, 16);
                document.getElementById('edit-end').value = classData.end_time.substring(0, 16);
                
                document.getElementById('edit-room').value = classData.room_id;
                document.getElementById('edit-teacher').value = classData.teacher_id;
                
                editForm.classList.remove('hidden');
            } else {
                editForm.classList.add('hidden');
            }
            
            // Show modal
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('detail-modal').classList.add('flex');
        }
        
        /**
         * Handles event drop or resize (drag and drop) from the calendar.
         */
        async function handleEventChange(info) {
            if (!(currentRole === 'teacher' || currentRole === 'admin')) {
                 // Restore event position if non-admin tries to move it (shouldn't happen if editable=false is set correctly)
                info.revert();
                return;
            }

            const event = info.event;
            const classId = event.id;
            const newStart = event.start.toISOString();
            const newEnd = event.end.toISOString();

            try {
                const { error } = await supabase
                    .from('classes')
                    .update({ start_time: newStart, end_time: newEnd })
                    .eq('id', classId);

                if (error) throw error;
                console.log('Class updated successfully via drag/drop.');
                // Realtime listener handles UI update
            } catch (error) {
                console.error('Error updating class schedule:', error.message);
                // Revert UI change if database update fails
                info.revert();
                // Custom modal/message box for error is highly recommended here instead of alert()
            }
        }


        // Supabase Admin/Teacher Login Handler
        async function handleSupabaseSignIn(e) {
            e.preventDefault();
            const name = document.getElementById('login-name').value.trim();
            const passkey = document.getElementById('login-passkey').value.trim();
            const errorEl = document.getElementById('login-error-message');
            const loginButton = document.getElementById('login-button');

            errorEl.classList.add('hidden');
            loginButton.disabled = true;
            loginButton.textContent = 'Logging in...';

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('full_name, role')
                    .eq('full_name', name)
                    .eq('passkey', passkey)
                    .single();

                if (error || !data) {
                    errorEl.textContent = 'Invalid credentials or user not found.';
                    errorEl.classList.remove('hidden');
                    return;
                }

                currentRole = data.role;
                currentUsername = data.full_name;

                // Close login modal and update UI
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('login-modal').classList.remove('flex');
                updateUserUI();
                renderCalendar(); // Re-render calendar to enable/disable editing

            } catch (error) {
                console.error('Supabase Login Error:', error);
                errorEl.textContent = 'An unexpected error occurred during login.';
                errorEl.classList.remove('hidden');
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Sign In';
            }
        }

        function handleSupabaseSignOut() {
            currentRole = 'student';
            currentUsername = 'Kiosk Viewer';
            updateUserUI();
            renderCalendar(); // Re-render calendar to disable editing
        }

        // Program Tab Click
        document.querySelectorAll('.program-tab').forEach(button => {
            button.addEventListener('click', (e) => {
                currentProgram = e.target.dataset.program;
                currentGrade = null;
                currentSection = null;
                
                document.querySelectorAll('.program-tab').forEach(btn => {
                    const isSelected = btn.dataset.program === currentProgram;
                    
                    btn.classList.remove('bg-pink-900', 'text-pink-100', 'bg-gray-700', 'text-gray-300', 'hover:bg-pink-800', 'hover:bg-gray-600');

                    if (isSelected) {
                        btn.classList.add('bg-pink-900', 'text-pink-100', 'hover:bg-pink-800');
                    } else {
                        btn.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                    }
                });
                renderFilters();
            });
        });

        // Grade Filter Change
        document.getElementById('grade-filter').addEventListener('change', (e) => {
            currentGrade = e.target.value || null;
            currentSection = null;
            renderFilters();
        });
        
        // Section Filter Change
        document.getElementById('section-filter').addEventListener('change', (e) => {
            currentSection = e.target.value || null;
        });

        // See Schedule Button Click
        document.getElementById('see-schedule-button').addEventListener('click', () => {
            renderCalendar();
        });

        // Assistant Button Click
        document.getElementById('ask-assistant-button').addEventListener('click', () => {
            renderChat();
            document.getElementById('assistant-modal').classList.remove('hidden');
            document.getElementById('assistant-modal').classList.add('flex');
        });

        // Map Toggle Button
        document.getElementById('map-toggle-button').addEventListener('click', () => {
            const calendarView = document.getElementById('calendar-view');
            const mapView = document.getElementById('map-view');

            if (mapView.classList.contains('hidden')) {
                calendarView.classList.add('hidden');
                mapView.classList.remove('hidden');
                document.getElementById('map-toggle-button').textContent = 'View Schedule';
                if (map) map.invalidateSize();
            } else {
                mapView.classList.add('hidden');
                calendarView.classList.remove('hidden');
                document.getElementById('map-toggle-button').textContent = 'View Floor Plan';
            }
        });

        // Menu Toggle Button
        document.getElementById('hamburger-menu').addEventListener('click', () => {
            document.getElementById('menu-sidebar').classList.add('open');
        });

        document.getElementById('close-menu').addEventListener('click', () => {
            document.getElementById('menu-sidebar').classList.remove('open');
        });

        // Authentication Button (Menu Sidebar)
        document.getElementById('auth-button').addEventListener('click', () => {
            if (currentRole === 'teacher' || currentRole === 'admin') {
                handleSupabaseSignOut();
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
                document.getElementById('login-modal').classList.add('flex');
            }
        });

        // Close Detail Modal
        document.getElementById('close-detail-modal').addEventListener('click', () => {
            document.getElementById('detail-modal').classList.add('hidden');
            document.getElementById('detail-modal').classList.remove('flex');
        });

        // Close Assistant Modal
        document.getElementById('close-assistant-modal').addEventListener('click', () => {
            document.getElementById('assistant-modal').classList.add('hidden');
            document.getElementById('assistant-modal').classList.remove('flex');
        });
        
        // Close Login Modal
        document.getElementById('close-login-modal').addEventListener('click', () => {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('login-modal').classList.remove('flex');
        });

        // Chat Form Submission
        document.getElementById('chat-form').addEventListener('submit', handleSendMessage);
        
        // Login Form Submission
        document.getElementById('login-form').addEventListener('submit', handleSupabaseSignIn);


        // ====================================================================
        // INITIALIZATION
        // ====================================================================

        async function init() {
            // 1. Firebase Auth for Canvas Environment (Keep for general auth environment setup)
            if (Object.keys(firebaseConfig).length > 0) {
                fbApp = firebase.initializeApp(firebaseConfig);
                auth = firebase.getAuth(fbApp);
                if (initialAuthToken) {
                    await firebase.signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Firebase Custom Token Sign-In Failed:", e));
                } else {
                    await firebase.signInAnonymously(auth).catch(e => console.error("Firebase Anonymous Sign-In Failed:", e));
                }
            } else {
                console.warn("Firebase config missing. Running without Firebase Auth.");
            }
            
            // 2. Initial UI Update (Default to student)
            updateUserUI(); 

            // 3. Load Data
            await fetchStaticData();
            setupRealtimeListener();

            // Set initial colors for program tabs (using permanent dark classes)
            document.querySelector('.program-tab[data-program="Junior High"]').classList.add('bg-pink-900', 'text-pink-100');
            document.querySelector('.program-tab[data-program="Senior High"]').classList.add('bg-gray-700', 'text-gray-300');
        }

        window.onload = init;

    </script>
</body>
</html>
