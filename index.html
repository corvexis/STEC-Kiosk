<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STEC Smart Kiosk | Ultimate v3</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap');

        :root {
            --primary: #06b6d4;
            --bg-main: #020617;
            --bg-card: #0f172a;
        }

        body {
            background-color: var(--bg-main);
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Prevent invisible layers from stealing clicks */
        .page-container {
            display: none;
            height: calc(100vh - 72px);
            width: 100%;
            overflow-y: auto;
            position: relative;
            z-index: 10;
        }

        .page-container.active {
            display: block;
        }

        /* High-Visibility Interactive Elements */
        .interactive-btn {
            cursor: pointer !important;
            transition: transform 0.1s active, opacity 0.2s;
            touch-action: manipulation;
        }

        .interactive-btn:active {
            transform: scale(0.96);
            opacity: 0.8;
        }

        /* Modal System */
        .modal-wrap {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-wrap.active {
            display: flex;
        }

        /* Calendar Override */
        .fc { 
            --fc-border-color: #334155;
            --fc-button-bg-color: #0891b2;
            --fc-button-border-color: #0891b2;
            height: 100% !important;
            background: #0f172a;
            border-radius: 12px;
            padding: 10px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- TOP NAVIGATION BAR -->
    <header class="h-[72px] bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6 z-[100] relative">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-cyan-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-900/20">
                <i class="fa-solid fa-graduation-cap text-white text-lg"></i>
            </div>
            <div>
                <h1 class="font-extrabold text-sm tracking-tighter leading-none">STEC SMART KIOSK</h1>
                <p class="text-[9px] text-cyan-500 font-bold mt-1 uppercase">v3.0.0 Production</p>
            </div>
        </div>

        <nav class="hidden md:flex gap-2">
            <button onclick="router.navigate('map')" id="nav-map" class="nav-link px-4 py-2 rounded-lg text-xs font-bold text-cyan-400 border-b-2 border-cyan-400">CAMPUS MAP</button>
            <button onclick="router.navigate('schedule')" id="nav-schedule" class="nav-link px-4 py-2 rounded-lg text-xs font-bold text-slate-400 hover:text-white">SCHEDULES</button>
            <button onclick="router.navigate('directory')" id="nav-directory" class="nav-link px-4 py-2 rounded-lg text-xs font-bold text-slate-400 hover:text-white">DIRECTORY</button>
        </nav>

        <button onclick="ui.openModal('modal-login')" id="staff-auth-btn" class="interactive-btn px-4 py-2 bg-slate-800 border border-slate-700 rounded-xl text-[10px] font-black tracking-widest hover:bg-slate-700">
            <i class="fa-solid fa-id-badge mr-2"></i> STAFF LOGIN
        </button>
    </header>

    <!-- VIEWPORT -->
    <main class="relative">
        
        <!-- PAGE: MAP -->
        <section id="page-map" class="page-container active p-6">
            <div class="w-full h-full bg-slate-900/50 border-2 border-dashed border-slate-800 rounded-[2rem] flex flex-col items-center justify-center text-center">
                <div class="mb-6 relative">
                    <i class="fa-solid fa-map-marked-alt text-8xl text-slate-800"></i>
                    <i class="fa-solid fa-location-dot text-3xl text-cyan-500 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 animate-bounce"></i>
                </div>
                <h2 class="text-2xl font-extrabold mb-2">Campus Navigator</h2>
                <p class="text-slate-500 text-sm max-w-xs mb-8">Tap a building or use the search to find classrooms and office locations.</p>
                <div class="grid grid-cols-2 gap-4">
                    <button class="interactive-btn px-8 py-4 bg-slate-800 rounded-2xl text-xs font-bold border border-slate-700">BUILDING A (JHS)</button>
                    <button class="interactive-btn px-8 py-4 bg-slate-800 rounded-2xl text-xs font-bold border border-slate-700">BUILDING B (SHS)</button>
                </div>
            </div>
        </section>

        <!-- PAGE: SCHEDULE -->
        <section id="page-schedule" class="page-container p-6">
            <div class="flex flex-col lg:flex-row gap-6 h-full">
                <!-- Sched Sidebar -->
                <div class="w-full lg:w-72 flex flex-col gap-4">
                    <div class="bg-slate-900 p-5 rounded-3xl border border-slate-800">
                        <label class="text-[10px] font-black text-cyan-500 uppercase tracking-widest mb-4 block">Select Level</label>
                        <div class="flex gap-2">
                            <button onclick="app.setLevel('Junior High')" id="lvl-jhs" class="flex-1 py-3 bg-cyan-600 rounded-2xl text-xs font-bold shadow-lg shadow-cyan-900/40 interactive-btn">JHS</button>
                            <button onclick="app.setLevel('Senior High')" id="lvl-shs" class="flex-1 py-3 bg-slate-800 rounded-2xl text-xs font-bold border border-slate-700 text-slate-400 interactive-btn">SHS</button>
                        </div>
                    </div>

                    <div id="admin-tools" class="hidden animate-in fade-in slide-in-from-bottom-2">
                        <div class="bg-emerald-950/20 p-5 rounded-3xl border border-emerald-500/20">
                            <label class="text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-4 block">Teacher Dashboard</label>
                            <button onclick="ui.openModal('modal-add')" class="w-full py-4 bg-emerald-600 rounded-2xl text-xs font-bold text-white mb-2 interactive-btn">
                                <i class="fa-solid fa-plus mr-2"></i> POST SESSION
                            </button>
                            <button onclick="app.loadUserPosts()" class="w-full py-4 bg-slate-800 rounded-2xl text-xs font-bold text-slate-300 interactive-btn">
                                MANAGE MY POSTS
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Sched Display -->
                <div class="flex-1 min-h-[500px] lg:h-full">
                    <div id="calendar"></div>
                </div>
            </div>
        </section>

        <!-- PAGE: DIRECTORY -->
        <section id="page-directory" class="page-container p-6">
            <div class="flex flex-col h-full">
                <div class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-3xl font-black">Personnel Directory</h2>
                        <p class="text-slate-500 text-sm">Faculty and administrative staff status</p>
                    </div>
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="text" oninput="app.filterStaff(this.value)" placeholder="Search names or roles..." class="w-full md:w-80 bg-slate-900 border border-slate-800 p-4 pl-12 rounded-2xl text-sm outline-none focus:border-cyan-500">
                    </div>
                </div>
                <div id="staff-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 pb-12">
                    <!-- Cards here -->
                </div>
            </div>
        </section>
    </main>

    <!-- MOBILE NAV -->
    <footer class="md:hidden fixed bottom-0 left-0 right-0 h-[72px] bg-slate-900 border-t border-slate-800 flex items-center justify-around px-4 z-[100]">
        <button onclick="router.navigate('map')" class="flex flex-col items-center gap-1 text-cyan-500 interactive-btn">
            <i class="fa-solid fa-map"></i><span class="text-[9px] font-black">MAP</span>
        </button>
        <button onclick="router.navigate('schedule')" class="flex flex-col items-center gap-1 text-slate-500 interactive-btn">
            <i class="fa-solid fa-calendar"></i><span class="text-[9px] font-black">SCHED</span>
        </button>
        <button onclick="router.navigate('directory')" class="flex flex-col items-center gap-1 text-slate-500 interactive-btn">
            <i class="fa-solid fa-users"></i><span class="text-[9px] font-black">STAFF</span>
        </button>
    </footer>

    <!-- MODAL: LOGIN -->
    <div id="modal-login" class="modal-wrap">
        <div class="bg-slate-900 border border-slate-800 p-8 rounded-[2.5rem] w-full max-w-sm shadow-2xl relative">
            <button onclick="ui.closeModals()" class="absolute top-6 right-6 text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
            <div class="text-center mb-8">
                <div class="w-14 h-14 bg-cyan-500/10 rounded-2xl flex items-center justify-center mx-auto mb-4 border border-cyan-500/20">
                    <i class="fa-solid fa-shield-halved text-2xl text-cyan-400"></i>
                </div>
                <h3 class="text-xl font-bold">Verification</h3>
                <p class="text-xs text-slate-500 mt-1 uppercase tracking-widest font-bold">Personnel Access Only</p>
            </div>
            <form onsubmit="app.login(event)" class="space-y-3">
                <input type="text" id="log-name" placeholder="Full Name" required class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl text-white outline-none focus:ring-1 focus:ring-cyan-500">
                <input type="password" id="log-pass" placeholder="Authorization Key" required class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl text-white outline-none focus:ring-1 focus:ring-cyan-500">
                <button type="submit" class="w-full py-4 bg-cyan-600 rounded-xl font-black text-xs tracking-widest interactive-btn">VERIFY IDENTITY</button>
            </form>
        </div>
    </div>

    <!-- MODAL: ADD POST -->
    <div id="modal-add" class="modal-wrap">
        <div class="bg-slate-900 border border-slate-800 p-8 rounded-[2.5rem] w-full max-w-lg shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <button onclick="ui.closeModals()" class="absolute top-6 right-6 text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-2xl font-black mb-6">Create New Session</h3>
            <form onsubmit="app.createPost(event)" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="sm:col-span-2">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Subject / Event Title</label>
                    <input type="text" id="f-subject" required class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl text-white outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Target Grade/Section</label>
                    <select id="f-program" required class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl text-white outline-none"></select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Venue / Room</label>
                    <select id="f-room" required class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl text-white outline-none"></select>
                </div>
                <div class="sm:col-span-2">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Schedule Date</label>
                    <input type="date" id="f-date" required class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl text-white outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Start Time</label>
                    <input type="time" id="f-start" required class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl text-white outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">End Time</label>
                    <input type="time" id="f-end" required class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl text-white outline-none">
                </div>
                <button type="submit" class="sm:col-span-2 py-5 bg-emerald-600 rounded-2xl font-black tracking-widest mt-4 interactive-btn">PUBLISH TO KIOSK</button>
            </form>
        </div>
    </div>

    <!-- MODAL: MANAGE POSTS -->
    <div id="modal-manage" class="modal-wrap">
        <div class="bg-slate-900 border border-slate-800 p-8 rounded-[2.5rem] w-full max-w-md shadow-2xl relative">
            <button onclick="ui.closeModals()" class="absolute top-6 right-6 text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-xl font-black mb-1">Active Posts</h3>
            <p class="text-xs text-slate-500 mb-6 uppercase font-bold tracking-widest">Delete items to remove from board</p>
            <div id="manage-list" class="space-y-2 max-h-80 overflow-y-auto pr-2">
                <!-- Posts list -->
            </div>
            <button onclick="ui.closeModals()" class="w-full py-4 mt-6 bg-slate-800 rounded-xl text-xs font-bold interactive-btn">CLOSE</button>
        </div>
    </div>

    <script>
        // --- CONFIG & DB ---
        const SUPA_URL = "https://nwwkgmlnnlsmbjrvcnaj.supabase.co";
        const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53d2tnbWxubmxzbWJqcnZjbmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTYxMDcsImV4cCI6MjA4MTM3MjEwN30.Stz0PC0XAxlAkmHpWxY9reIeVzbXaDKuiSUOrJ4HB7Y";
        const sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);

        // --- GLOBAL STATE ---
        const state = {
            currentUser: null,
            currentLevel: 'Junior High',
            programs: [],
            rooms: [],
            profiles: [],
            calendar: null
        };

        // --- ROUTING ENGINE (FIXED INTERACTION) ---
        const router = {
            navigate(pageId) {
                console.log("Navigating to:", pageId);
                
                // 1. Hide all pages
                document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
                
                // 2. Show active page
                const target = document.getElementById(`page-${pageId}`);
                if (target) target.classList.add('active');

                // 3. Update Nav UI (Desktop)
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.className = "nav-link px-4 py-2 rounded-lg text-xs font-bold text-slate-400 hover:text-white";
                });
                const activeLink = document.getElementById(`nav-${pageId}`);
                if (activeLink) activeLink.className = "nav-link px-4 py-2 rounded-lg text-xs font-bold text-cyan-400 border-b-2 border-cyan-400";

                // 4. Update Nav UI (Mobile)
                document.querySelectorAll('footer button').forEach(btn => btn.className = "flex flex-col items-center gap-1 text-slate-500 interactive-btn");
                const activeMob = Array.from(document.querySelectorAll('footer button')).find(b => b.innerText.includes(pageId.toUpperCase().slice(0,3)));
                if (activeMob) activeMob.className = "flex flex-col items-center gap-1 text-cyan-500 interactive-btn";

                // 5. Trigger Tab-specific init
                if (pageId === 'schedule') app.renderCalendar();
                if (pageId === 'directory') app.loadDirectory();
            }
        };

        // --- UI HELPERS ---
        const ui = {
            openModal(id) {
                document.getElementById(id).classList.add('active');
            },
            closeModals() {
                document.querySelectorAll('.modal-wrap').forEach(m => m.classList.remove('active'));
            }
        };

        // --- CORE APP LOGIC ---
        const app = {
            async init() {
                console.log("Initializing App...");
                const [progData, roomData] = await Promise.all([
                    sb.from('programs').select('*').order('name'),
                    sb.from('rooms').select('*').order('name')
                ]);
                state.programs = progData.data || [];
                state.rooms = roomData.data || [];

                // Fill dropdowns
                document.getElementById('f-program').innerHTML = state.programs.map(p => `<option value="${p.id}">${p.name} - ${p.grade_level}${p.section}</option>`).join('');
                document.getElementById('f-room').innerHTML = state.rooms.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            },

            async login(e) {
                e.preventDefault();
                const name = document.getElementById('log-name').value.trim();
                const pass = document.getElementById('log-pass').value.trim();

                const { data, error } = await sb.from('profiles').select('*').eq('full_name', name).eq('passkey', pass).single();

                if (data) {
                    state.currentUser = data;
                    document.getElementById('admin-tools').classList.remove('hidden');
                    document.getElementById('staff-auth-btn').innerHTML = `<i class="fa-solid fa-circle-check mr-2 text-emerald-400"></i> ${data.full_name.toUpperCase()}`;
                    document.getElementById('staff-auth-btn').className = "interactive-btn px-4 py-2 bg-emerald-950/20 border border-emerald-500/30 rounded-xl text-[10px] font-black tracking-widest text-emerald-400";
                    ui.closeModals();
                } else {
                    alert("Authorization failed. Please check your credentials.");
                }
            },

            setLevel(lvl) {
                state.currentLevel = lvl;
                const jhs = document.getElementById('lvl-jhs');
                const shs = document.getElementById('lvl-shs');
                
                if (lvl === 'Junior High') {
                    jhs.className = "flex-1 py-3 bg-cyan-600 rounded-2xl text-xs font-bold shadow-lg shadow-cyan-900/40 interactive-btn";
                    shs.className = "flex-1 py-3 bg-slate-800 rounded-2xl text-xs font-bold border border-slate-700 text-slate-400 interactive-btn";
                } else {
                    shs.className = "flex-1 py-3 bg-cyan-600 rounded-2xl text-xs font-bold shadow-lg shadow-cyan-900/40 interactive-btn";
                    jhs.className = "flex-1 py-3 bg-slate-800 rounded-2xl text-xs font-bold border border-slate-700 text-slate-400 interactive-btn";
                }

                if (state.calendar) state.calendar.refetchEvents();
            },

            renderCalendar() {
                const el = document.getElementById('calendar');
                if (state.calendar) {
                    state.calendar.updateSize();
                    state.calendar.refetchEvents();
                    return;
                }

                state.calendar = new FullCalendar.Calendar(el, {
                    initialView: window.innerWidth < 1024 ? 'listDay' : 'timeGridDay',
                    headerToolbar: { left: 'prev,next', center: 'title', right: '' },
                    slotMinTime: '07:00:00',
                    slotMaxTime: '18:00:00',
                    allDaySlot: false,
                    themeSystem: 'standard',
                    events: async (info, success, failure) => {
                        const levelIds = state.programs.filter(p => p.name === state.currentLevel).map(p => p.id);
                        const { data, error } = await sb.from('classes').select('*, rooms(name)').in('program_id', levelIds);
                        if (error) return failure(error);
                        success((data || []).map(c => ({
                            id: c.id,
                            title: `${c.subject} (${c.rooms?.name || 'RM'})`,
                            start: c.start_time,
                            end: c.end_time
                        })));
                    }
                });
                state.calendar.render();
            },

            async loadDirectory() {
                const { data } = await sb.from('profiles').select('*').order('full_name');
                state.profiles = data || [];
                this.renderStaffList(state.profiles);
            },

            renderStaffList(list) {
                const grid = document.getElementById('staff-grid');
                grid.innerHTML = list.map(p => `
                    <div class="bg-slate-900 border border-slate-800 p-5 rounded-[2rem] flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-slate-800 flex items-center justify-center font-black text-cyan-400 border border-slate-700 shadow-inner">
                            ${p.full_name[0]}
                        </div>
                        <div class="min-w-0">
                            <h4 class="text-sm font-bold truncate">${p.full_name}</h4>
                            <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mt-1">${p.role || 'Personnel'}</p>
                        </div>
                    </div>
                `).join('');
            },

            filterStaff(q) {
                const filtered = state.profiles.filter(p => p.full_name.toLowerCase().includes(q.toLowerCase()));
                this.renderStaffList(filtered);
            },

            async createPost(e) {
                e.preventDefault();
                const payload = {
                    subject: document.getElementById('f-subject').value,
                    program_id: document.getElementById('f-program').value,
                    room_id: document.getElementById('f-room').value,
                    teacher_id: state.currentUser.id,
                    start_time: `${document.getElementById('f-date').value}T${document.getElementById('f-start').value}:00Z`,
                    end_time: `${document.getElementById('f-date').value}T${document.getElementById('f-end').value}:00Z`
                };

                const { error } = await sb.from('classes').insert([payload]);
                if (!error) {
                    ui.closeModals();
                    if (state.calendar) state.calendar.refetchEvents();
                    e.target.reset();
                } else {
                    alert("Error saving session. Please try again.");
                }
            },

            async loadUserPosts() {
                ui.openModal('modal-manage');
                const { data } = await sb.from('classes').select('*, rooms(name)').eq('teacher_id', state.currentUser.id);
                const list = document.getElementById('manage-list');
                list.innerHTML = (data || []).map(c => `
                    <div class="bg-slate-950 border border-slate-800 p-4 rounded-2xl flex items-center justify-between">
                        <div>
                            <div class="text-xs font-bold text-white">${c.subject}</div>
                            <div class="text-[9px] text-slate-500 font-bold mt-1">${c.rooms?.name} | ${new Date(c.start_time).toLocaleDateString()}</div>
                        </div>
                        <button onclick="app.deletePost('${c.id}')" class="w-9 h-9 bg-red-500/10 text-red-500 rounded-xl hover:bg-red-500 hover:text-white transition-all">
                            <i class="fa-solid fa-trash-can text-sm"></i>
                        </button>
                    </div>
                `).join('') || `<p class="text-center py-8 text-xs text-slate-600">No active posts found.</p>`;
            },

            async deletePost(id) {
                if (!confirm("Are you sure you want to delete this session?")) return;
                await sb.from('classes').delete().eq('id', id);
                this.loadUserPosts();
                if (state.calendar) state.calendar.refetchEvents();
            }
        };

        // --- BOOTSTRAP ---
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
